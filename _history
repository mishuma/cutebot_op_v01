{"entries":[{"timestamp":1760373307327,"editorVersion":"8.0.16","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":182,"diffs":[[1,"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <block type=\"pxt-on-start\"></block>\n  <block type=\"device_forever\"></block>\n</xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":46,"diffs":[[1,"\n"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":204,"length1":39,"diffs":[[1,"        \"README.md\"\n"]]},{"start1":231,"length1":31,"diffs":[[1,"    \"additionalFilePaths\": []\n"]]}]},{"type":"added","filename":"main.py","value":"def on_forever():\n    pass\nbasic.forever(on_forever)\n"}]},{"timestamp":1760373317279,"editorVersion":"8.0.16","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":31252,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables></variables><block type=\"pxt-on-start\" x=\"0\" y=\"0\"></block><block type=\"device_forever\" x=\"205\" y=\"0\"></block></xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":5015,"diffs":[[1,"basic.forever(function on_forever() {\n    \n"]]},{"start1":46,"length1":209,"diffs":[[1,""]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":2,"length1":31,"diffs":[[1,"    \"name\": \"Untitled\",\n"]]},{"start1":92,"length1":111,"diffs":[[1,"        \"radio\": \"*\",\n        \"microphone\": \"*\"\n"]]},{"start1":250,"length1":31,"diffs":[[1,"    \"preferredEditor\": \"pyprj\"\n"]]}]},{"type":"edited","filename":"main.py","patch":[{"start1":0,"length1":0,"diffs":[[1,"def on_forever():\n    pass\nbasic.forever(on_forever)\n"]]}]}]},{"timestamp":1760384728798,"editorVersion":"8.0.16","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":1041,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\".7-(GTJeTMT!80lik!Ey\">d</variable><variable id=\"08b_.n}f!9H@DdhvUqSz\">t</variable><variable id=\"e^%e@G*DBjgS4wnDU0cn\">q</variable><variable id=\"G%}5-q6JQb(j[;]eYJ)o\">P_OK</variable><variable id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</variable><variable id=\"5bjeW$0OVJ`?K)j-7vrF\">core</variable><variable id=\"b+Y_X^Af0C3;0F[C6c0O\">P_O</variable><variable id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</variable><variable id=\"s=?V7i/]NdU2Mnxz#CK9\">cmd</variable><variable id=\"5Jh7Y[04|{j,VJ6UsmHy\">line</variable><variable id=\"F,cup.!hp|Q:ZB*@Dngd\">QDEPTH</variable><variable id=\"p;Cl#3XpanZ{JL*)vS24\">P_S</variable><variable id=\"V#SB_p)9k!*}exvq=RD$\">ok</variable><variable id=\"^MXhC4U#3wu^Jh3@ba0}\">g</variable></variables><comment x=\"0\" y=\"0\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (MakeCode-safe) =====\nCommands (one per line, newline-terminated):\n:SEQ,OP,ARGS*\\n\nSEQ = 2-hex chosen by the app (00..FF)\nOP  = MV|SP|TL|TR|BK|HL|BZ|EC\nARGS (hex bytes, 00..FF):\nMV,left,right         -&gt; cuteBot.motors(left,right)   (0..100; negatives reverse)\n"]]},{"start1":1155,"length1":371,"diffs":[[1,"TL,00                 -&gt; turn left (no args used)\nTR,00                 -&gt; turn right (no args used)\nBK,ss                 -&gt; backward via motors(-ss,-ss); default 50 if ss=0\nHL,01|00              -&gt; headlights on (white) / off\nHL,RR,GG,BB           -&gt; headlights set to RGB color\nBZ,HH,LL,DD           -&gt; buzzer tone; freq=(HH&lt;&lt;8)|LL Hz, duration=DD*10ms\nEC,00                 -&gt; echo/no-op (handy for latency tests)\n"]]},{"start1":1601,"length1":34932,"diffs":[[1,"Replies (one line):\n:SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n\nTelemetry pushes (no SEQ):\n#DIST,cc              -&gt; ultrasonic distance in centimeters, ~2Hz\n</comment><comment x=\"0\" y=\"0\" w=\"480\" h=\"120\">\n---------- parser fills globals (avoids union/object return pitfalls) ----------\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">line</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_C = 0\" numlines=\"1\" declaredvars=\"P_C\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_B = 0\" numlines=\"1\" declaredvars=\"P_B\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_A = 0\" numlines=\"1\" declaredvars=\"P_A\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_O = &quot;&quot;\" numlines=\"1\" declaredvars=\"P_O\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">op</comment><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_S = 0\" numlines=\"1\" declaredvars=\"P_S\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">seq</comment><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: any[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"variables_set\"><field name=\"VAR\" id=\"F,cup.!hp|Q:ZB*@Dngd\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue (array of plain objects with short keys) ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: any) { if (q.length &gt;= QDEPTH) return false; q.push(c); return true }\" numlines=\"1\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: any, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;: // motors with speeds 0..100 (negatives reverse)\" line3=\"            cuteBot.motors(cmd.a, cmd.b)\" line4=\"            break\" line5=\"\" line6=\"        case &quot;SP&quot;: // stop\" line7=\"            cuteBot.stopcar()\" line8=\"            break\" line9=\"\" line10=\"        case &quot;TL&quot;: // turn left (no args)\" line11=\"            cuteBot.turnleft()\" line12=\"            break\" line13=\"\" line14=\"        case &quot;TR&quot;: // turn right (no args)\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"\" line18=\"        case &quot;BK&quot;: { // backward via negative motors\" line19=\"            const spd = cmd.a &gt; 0 ? cmd.a : 50\" line20=\"            cuteBot.motors(-spd, -spd)\" line21=\"            break\" line22=\"        }\" line23=\"\" line24=\"        case &quot;HL&quot;: {\" line25=\"            // If 3 args present (RGB): color = (a&lt;&lt;16)|(b&lt;&lt;8)|c\" line26=\"            // Note: pure black (0,0,0) equals &quot;off&quot;.\" line27=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line28=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line29=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line30=\"            } else {\" line31=\"                // Single-arg on/off (a = 0/!=0)\" line32=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\" line33=\"            }\" line34=\"            break\" line35=\"        }\" line36=\"\" line37=\"        case &quot;BZ&quot;: {\" line38=\"            // freq = (a&lt;&lt;8)|b (Hz), duration = c * 10 ms\" line39=\"            const freq = ((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF)\" line40=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line41=\"            if (dur &lt;= 0) dur = 100\" line42=\"            const f = Math.max(100, Math.min(5000, freq)) // clamp for reliability\" line43=\"            music.playTone(f, dur)\" line44=\"            break\" line45=\"        }\" line46=\"\" line47=\"        case &quot;EC&quot;:\" line48=\"            // echo (no motion)\" line49=\"            break\" line50=\"\" line51=\"        default:\" line52=\"            sendErr(cmd.s, 0x01) // unknown op\" line53=\"            done()\" line54=\"            return\" line55=\"    }\" line56=\"\" line57=\"    control.inBackground(() =&gt; {\" line58=\"        basic.pause(10)       // tiny yield; keeps BLE responsive\" line59=\"        sendAck(cmd.s)\" line60=\"        done()\" line61=\"    })\" line62=\"}\" numlines=\"63\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"925\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"5Jh7Y[04|{j,VJ6UsmHy\">line</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"J2Js*{d7Ay~6iiw.pqvG\"><arg name=\"line\" id=\"2hxvlaprobg65lqhb6zm6\" type=\"string\"></arg></mutation><value name=\"2hxvlaprobg65lqhb6zm6\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5Jh7Y[04|{j,VJ6UsmHy\">line</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></statement><next><block type=\"controls_if\"><comment pinned=\"false\" h=\"80\" w=\"160\">If worker+queue saturated -&gt; BUSY using parsed seq</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"e^%e@G*DBjgS4wnDU0cn\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"F,cup.!hp|Q:ZB*@Dngd\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"rM5MV5_T0pe]}zg390Uy\"><arg name=\"s\" id=\"tjrmyxvfvtij4pcxulfvb\" type=\"number\"></arg></mutation><value name=\"tjrmyxvfvtij4pcxulfvb\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"p;Cl#3XpanZ{JL*)vS24\">P_S</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const ok = qPush({ s: P_S, o: P_O, a: P_A, b: P_B, c: P_C })\" numlines=\"1\" declaredvars=\"ok\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"V#SB_p)9k!*}exvq=RD$\">ok</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"rM5MV5_T0pe]}zg390Uy\"><arg name=\"s\" id=\"tjrmyxvfvtij4pcxulfvb\" type=\"number\"></arg></mutation><value name=\"tjrmyxvfvtij4pcxulfvb\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"p;Cl#3XpanZ{JL*)vS24\">P_S</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"O7AUX+d2fd}i{9P2EZB~\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"every_interval\" x=\"1724\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry (distance ~2Hz) ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"^MXhC4U#3wu^Jh3@ba0}\">g</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"^MXhC4U#3wu^Jh3@ba0}\">g</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"2427\" y=\"20\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"yvgqisnpwumg1ranbu1w\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\".7-(GTJeTMT!80lik!Ey\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\".7-(GTJeTMT!80lik!Ey\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\".7-(GTJeTMT!80lik!Ey\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3388\" y=\"20\"><mutation name=\"parseHexByte\" functionid=\"j.i+D,Fw{]*C#Yzi,:r$\"><arg name=\"s\" id=\"qhg1wp64nenpb4qdlv7la\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"qhg1wp64nenpb4qdlv7la\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"08b_.n}f!9H@DdhvUqSz\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48      // '0'-'9'\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55 // 'A'-'F'\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"2972\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"6w0ncovd4akqfp3zkeyiye\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"425\" y=\"2972\"><mutation name=\"sendAck\" functionid=\"%oY^]/5T/^N?GFgEbQ}@\"><arg name=\"s\" id=\"inqtbnr61na2zz2xzlmgj\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"inqtbnr61na2zz2xzlmgj\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><value name=\"6w0ncovd4akqfp3zkeyiye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">s</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1058\" y=\"2972\"><mutation name=\"sendBusy\" functionid=\"rM5MV5_T0pe]}zg390Uy\"><arg name=\"s\" id=\"tjrmyxvfvtij4pcxulfvb\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"tjrmyxvfvtij4pcxulfvb\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><value name=\"6w0ncovd4akqfp3zkeyiye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">s</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1700\" y=\"2972\"><mutation name=\"sendErr\" functionid=\"1*qeqF35JqA40Y%;S5$-\"><arg name=\"s\" id=\"7gvo2pn1xmi4ou7q0oz1\" type=\"number\"></arg><arg name=\"ec\" id=\"dh98rvb4dwo1w1n16d4m\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"7gvo2pn1xmi4ou7q0oz1\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><value name=\"dh98rvb4dwo1w1n16d4m\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><value name=\"6w0ncovd4akqfp3zkeyiye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">s</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2089\" y=\"2972\"><mutation name=\"qPop\" functionid=\"PBsT)ZC|iA|xK%oUnQ@4\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"e^%e@G*DBjgS4wnDU0cn\">q</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2639\" y=\"2972\"><mutation name=\"parseLine\" functionid=\"J2Js*{d7Ay~6iiw.pqvG\"><arg name=\"line\" id=\"2hxvlaprobg65lqhb6zm6\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><value name=\"2hxvlaprobg65lqhb6zm6\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"variables_set\"><field name=\"VAR\" id=\"G%}5-q6JQb(j[;]eYJ)o\">P_OK</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5bjeW$0OVJ`?K)j-7vrF\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const s = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"s\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_S = isNaN(s) ? 0 : (s &amp; 0xFF)\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"b+Y_X^Af0C3;0F[C6c0O\">P_O</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_index_get\"><value name=\"LIST\"><block type=\"variables_get\"><field name=\"VAR\" id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</field></block></value><value name=\"INDEX\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow></value></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_A = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_B = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_C = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"G%}5-q6JQb(j[;]eYJ)o\">P_OK</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3383\" y=\"2972\"><mutation name=\"pump\" functionid=\"O7AUX+d2fd}i{9P2EZB~\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"e^%e@G*DBjgS4wnDU0cn\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"s=?V7i/]NdU2Mnxz#CK9\">cmd</field><comment pinned=\"false\" h=\"80\" w=\"160\">{ s,o,a,b,c }</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"PBsT)ZC|iA|xK%oUnQ@4\"></mutation></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></statement></block></xml>"]]}]},{"type":"edited","filename":"main.ts","patch":[{"start1":0,"length1":185,"diffs":[[1,"// ===== Cutebot + BLE UART Command Processor (MakeCode TypeScript) =====\n// Line format from the app (newline-terminated):\n//   :SEQ,OP,ARGS*\\n\n// SEQ: 2 hex digits (00..FF) chosen by the app.\n// OP : MV|SP|TL|TR|BK|HL|BZ|EC\n"]]},{"start1":229,"length1":88,"diffs":[[1,"// ARGS (hex bytes 00..FF):\n//   MV,left,right         -> cuteBot.motors(left,right) (0..100; negatives reverse)\n"]]},{"start1":377,"length1":333,"diffs":[[1,"//   TL,00                 -> turn left (no args used)\n//   TR,00                 -> turn right (no args used)\n//   BK,ss                 -> go backward via motors(-ss,-ss); if ss==0 use 50\n//   HL,01|00              -> headlights on (white) / off\n//   HL,RR,GG,BB           -> set headlights to RGB color\n//   BZ,HH,LL,DD           -> buzzer; freq=(HH<<8)|LL Hz, duration=DD*10 ms\n"]]},{"start1":803,"length1":106,"diffs":[[1,"// Replies (newline-terminated):\n//   :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n//\n// Telemetry (push, no SEQ):\n//   #DIST,cc              -> ultrasonic distance (cm) ~2 Hz\n"]]},{"start1":1000,"length1":738,"diffs":[[1,""]]},{"start1":1201,"length1":21,"diffs":[[1,""]]},{"start1":1387,"length1":91,"diffs":[[1,"        if (c >= 48 && c <= 57) d = c - 48      // '0'..'9'\n        else if (c >= 65 && c <= 70) d = c - 55 // 'A'..'F'\n"]]},{"start1":1586,"length1":96,"diffs":[[1,""]]},{"start1":1883,"length1":31,"diffs":[[1,"// ---------- queue (plain array of tiny objects) ----------\n"]]},{"start1":1961,"length1":20,"diffs":[[1,"const q: any[] = []\n"]]},{"start1":1999,"length1":25,"diffs":[[1,"function qPush(c: any) {\n"]]},{"start1":2097,"length1":65,"diffs":[[1,"function qPop() {\n"]]},{"start1":2139,"length1":263,"diffs":[[1,"// ---------- parser -> returns tiny object or null ----------\nfunction parseLine(line: string) {\n    if (!line || line.length < 5) return null\n"]]},{"start1":2326,"length1":1,"diffs":[[1,""]]},{"start1":2437,"length1":1,"diffs":[[1,""]]},{"start1":2476,"length1":46,"diffs":[[1,"    const op = parts[1]\n"]]},{"start1":2756,"length1":80,"diffs":[[1,"// ---------- execute one command (expects {s,o,a,b,c}) ----------\nfunction runOne(cmd: any, done: () => void) {\n"]]},{"start1":2890,"length1":146,"diffs":[[1,"        case \"MV\":\n            // motors with speeds (0..100; negatives reverse)\n            cuteBot.motors(cmd.a, cmd.b)\n"]]},{"start1":3030,"length1":10,"diffs":[[1,"\n"]]},{"start1":3098,"length1":0,"diffs":[[1,"\n"]]},{"start1":3167,"length1":0,"diffs":[[1,"\n"]]},{"start1":3237,"length1":0,"diffs":[[1,"\n"]]},{"start1":3259,"length1":62,"diffs":[[1,"            // No cuteBot.back(); simulate with negative motors\n            const spd = cmd.a > 0 ? cmd.a : 50\n"]]},{"start1":3437,"length1":0,"diffs":[[1,"\n"]]},{"start1":3459,"length1":0,"diffs":[[1,"            // If b or c provided -> RGB; otherwise on/off via a\n"]]},{"start1":3725,"length1":205,"diffs":[[1,""]]},{"start1":3746,"length1":372,"diffs":[[1,"                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\n"]]},{"start1":3875,"length1":0,"diffs":[[1,"\n"]]},{"start1":3897,"length1":82,"diffs":[[1,"            const freq = ((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF)\n"]]},{"start1":4039,"length1":163,"diffs":[[1,"            const f = Math.max(100, Math.min(5000, freq))\n            music.playTone(f, dur)\n"]]},{"start1":4160,"length1":0,"diffs":[[1,"\n"]]},{"start1":4180,"length1":0,"diffs":[[1,"            // echo/no-op\n"]]},{"start1":4224,"length1":0,"diffs":[[1,"\n"]]},{"start1":4242,"length1":33,"diffs":[[1,"            sendErr(cmd.s, 0x01) // unknown op\n"]]},{"start1":4334,"length1":0,"diffs":[[1,"    // Tiny yield so BLE stays responsive, then ACK\n"]]},{"start1":4563,"length1":74,"diffs":[[1,"    const cmd = qPop()\n"]]},{"start1":4637,"length1":37,"diffs":[[1,"// ---------- BLE receive (line-oriented) ----------\n"]]},{"start1":4739,"length1":154,"diffs":[[1,"    const line = bluetooth.uartReadUntil(\"\\n\")\n    const cmd = parseLine(line)\n    if (!cmd) return\n\n    // Backpressure if worker+queue are saturated\n"]]},{"start1":4954,"length1":0,"diffs":[[1,"\n"]]},{"start1":5019,"length1":40,"diffs":[[1,"// ---------- telemetry (distance ~2 Hz) ----------\n"]]}]},{"type":"edited","filename":"pxt.json","patch":[{"start1":320,"length1":286,"diffs":[[1,"    \"preferredEditor\": \"tsprj\"\n"]]}]}]},{"timestamp":1761146233204,"editorVersion":"8.0.17","changes":[{"type":"edited","filename":"pxt.json","patch":[{"start1":448,"length1":140,"diffs":[[1,"                    \"open\": 1,\n                    \"whitelist\": 0,\n                    \"security_level\": null\n"]]}]}]},{"timestamp":1761146309758,"editorVersion":"8.0.17","changes":[{"type":"edited","filename":"pxt.json","patch":[{"start1":448,"length1":149,"diffs":[[1,"                    \"open\": 0,\n                    \"whitelist\": 1,\n                    \"security_level\": \"SECURITY_MODE_ENCRYPTION_NO_MITM\"\n"]]}]}]},{"timestamp":1761146386988,"editorVersion":"8.0.17","changes":[{"type":"edited","filename":"main.blocks","patch":[{"start1":0,"length1":807,"diffs":[[1,"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</variable><variable id=\"](5e[stlsG_ssIAIIhM0\">d</variable><variable id=\"IdeJ/P^a#Vn2X[rLgd5M\">t</variable><variable id=\"#;yrbqUAUD?PB{|*1Y[i\">q</variable><variable id=\"DvFb~QP;Lm(;?C3;q~%#\">line</variable><variable id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</variable><variable id=\"4)m-TU+K.AtkG_1KNIeR\">core</variable><variable id=\"{W9.v0).NR68_,Qm/To=\">busy</variable><variable id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</variable><variable id=\"k.hm9|Z#os50|-5W%kHq\">raw</variable><variable id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</variable><variable id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</variable><variable id=\"vadM6WUIUEojn!e#!Bip\">g</variable></variables><comment x=\"748\" y=\"4481\" w=\"480\" h=\"360\">\n"]]},{"start1":1546,"length1":80,"diffs":[[1,"</comment><comment x=\"1273\" y=\"4481\" w=\"330\" h=\"120\">\n"]]},{"start1":1634,"length1":330,"diffs":[[1,"</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">s</field></block><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">raw</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: Cmd[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"type Cmd = { s: number, o: string, a: number, b: number, c: number }\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: Cmd) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: Cmd, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;: {\" line3=\"            const L = clamp(cmd.a, -100, 100)\" line4=\"            const R = clamp(cmd.b, -100, 100)\" line5=\"            cuteBot.motors(L, R)\" line6=\"            break\" line7=\"        }\" line8=\"        case &quot;SP&quot;:\" line9=\"            cuteBot.stopcar()\" line10=\"            break\" line11=\"        case &quot;TL&quot;:\" line12=\"            cuteBot.turnleft()\" line13=\"            break\" line14=\"        case &quot;TR&quot;:\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"        case &quot;BK&quot;: {\" line18=\"            const spd = cmd.a &gt; 0 ? clamp(cmd.a, 0, 100) : 50\" line19=\"            cuteBot.motors(-spd, -spd)\" line20=\"            break\" line21=\"        }\" line22=\"        case &quot;HL&quot;: {\" line23=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line24=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line25=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line26=\"                const rr = hex2((color &gt;&gt; 16) &amp; 0xFF)\" line27=\"                const gg = hex2((color &gt;&gt; 8) &amp; 0xFF)\" line28=\"                const bb = hex2(color &amp; 0xFF)\" line29=\"                send(&quot;#LED,&quot; + rr + gg + bb + &quot;\\n&quot;)\" line30=\"            } else {\" line31=\"                const on = (cmd.a &amp; 0xFF) != 0\" line32=\"                const color2 = on ? 0xFFFFFF : 0x000000\" line33=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color2)\" line34=\"                const rr2 = hex2((color2 &gt;&gt; 16) &amp; 0xFF)\" line35=\"                const gg2 = hex2((color2 &gt;&gt; 8) &amp; 0xFF)\" line36=\"                const bb2 = hex2(color2 &amp; 0xFF)\" line37=\"                send(&quot;#LED,&quot; + rr2 + gg2 + bb2 + &quot;\\n&quot;)\" line38=\"            }\" line39=\"            break\" line40=\"        }\" line41=\"        case &quot;BZ&quot;: {\" line42=\"            const freq = clamp(((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF), 100, 5000)\" line43=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line44=\"            if (dur &lt;= 0) dur = 100\" line45=\"            music.playTone(freq, dur)\" line46=\"            control.inBackground(() =&gt; {\" line47=\"                basic.pause(dur)\" line48=\"                send(&quot;#BUZ,done\\n&quot;)\" line49=\"            })\" line50=\"            break\" line51=\"        }\" line52=\"        case &quot;EC&quot;:\" line53=\"            break\" line54=\"        default:\" line55=\"            sendErr(cmd.s, 0x01)\" line56=\"            done()\" line57=\"            return\" line58=\"    }\" line59=\"\" line60=\"    control.inBackground(() =&gt; {\" line61=\"        basic.pause(10)\" line62=\"        sendAck(cmd.s)\" line63=\"        done()\" line64=\"    })\" line65=\"}\" numlines=\"66\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_connected\" x=\"1181\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"1599\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"k.hm9|Z#os50|-5W%kHq\">raw</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"pm`W2S*=EoYIu+Z.!~f2\"><arg name=\"raw\" id=\"uz0mku3fk8gzj4hhr0v\" type=\"string\"></arg></mutation><value name=\"uz0mku3fk8gzj4hhr0v\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"k.hm9|Z#os50|-5W%kHq\">raw</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendErr\" functionid=\"?h[1fy@t{kLfv!2P%elT\"><arg name=\"seq\" id=\"7ome0ocag18rbht7ut0jh\" type=\"number\"></arg><arg name=\"ec\" id=\"hn32k7nkug5m0eio9zux\" type=\"number\"></arg></mutation><value name=\"7ome0ocag18rbht7ut0jh\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value><value name=\"hn32k7nkug5m0eio9zux\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><value name=\"s56py5ztn5p0vdx64m7l\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><value name=\"s56py5ztn5p0vdx64m7l\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"c#Wg.,4A,#Eshh:z#Gbq\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_disconnected\" x=\"2398\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"device_clear_display\"><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></next></block></next></block></statement></block><block type=\"device_button_event\" x=\"2825\" y=\"20\"><field name=\"NAME\">Button.A</field><comment pinned=\"false\" h=\"80\" w=\"160\">--- Button A: show card name quickly ---</comment><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"basic.showString(control.deviceName(), 50)\" numlines=\"1\"></mutation><next><block type=\"controls_if\"><mutation else=\"1\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">restore icon based on BLE state</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field></block></value><statement name=\"DO0\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></statement><statement name=\"ELSE\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></statement></block></next></block></statement></block><block type=\"every_interval\" x=\"3306\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry loop ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"vadM6WUIUEojn!e#!Bip\">g</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"vadM6WUIUEojn!e#!Bip\">g</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4008\" y=\"20\"><mutation name=\"clamp\" functionid=\"Jep9@0^At#P7ldJ_!Y@v\"><arg name=\"v\" id=\"5xez5ne62n9park8h2v11\" type=\"number\"></arg><arg name=\"lo\" id=\"gapumokl7eapn2h1efp0o\" type=\"number\"></arg><arg name=\"hi\" id=\"gecefb66x1wdoar1a2nv\" type=\"number\"></arg></mutation><field name=\"function_name\">clamp</field><value name=\"5xez5ne62n9park8h2v11\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">v</field></block></value><value name=\"gapumokl7eapn2h1efp0o\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">lo</field></block></value><value name=\"gecefb66x1wdoar1a2nv\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">hi</field></block></value><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"math_op2\"><field name=\"op\">max</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">lo</field></block></value><value name=\"y\"><block type=\"math_op2\"><field name=\"op\">min</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">hi</field></block></value><value name=\"y\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">v</field></block></value></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"3292\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"apjmq4fa9kiyk5mwazgis\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"981\" y=\"3292\"><mutation name=\"parseHexByte\" functionid=\"(7^gB|RQNFpRk_$36~:a\"><arg name=\"s\" id=\"4f2rlrtsm19srbd0pcvi\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"4f2rlrtsm19srbd0pcvi\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"IdeJ/P^a#Vn2X[rLgd5M\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"1509\" y=\"3292\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"tyx7r1qtiggzv6h3wf3q\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"1914\" y=\"3292\"><mutation name=\"sendAck\" functionid=\"x)Hj)f)f/c8`|l9w#xw4\"><arg name=\"seq\" id=\"2vcb4j5x6slht99wsw814\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"2vcb4j5x6slht99wsw814\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2547\" y=\"3292\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"s56py5ztn5p0vdx64m7l\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3189\" y=\"3292\"><mutation name=\"sendErr\" functionid=\"?h[1fy@t{kLfv!2P%elT\"><arg name=\"seq\" id=\"7ome0ocag18rbht7ut0jh\" type=\"number\"></arg><arg name=\"ec\" id=\"hn32k7nkug5m0eio9zux\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"7ome0ocag18rbht7ut0jh\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"hn32k7nkug5m0eio9zux\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3578\" y=\"3292\"><mutation name=\"qPop\" functionid=\"rt@H:(Wvo+VNR,}M6i.D\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4128\" y=\"3292\"><mutation name=\"parseLine\" functionid=\"pm`W2S*=EoYIu+Z.!~f2\"><arg name=\"raw\" id=\"uz0mku3fk8gzj4hhr0v\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser ----------</comment><value name=\"uz0mku3fk8gzj4hhr0v\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">raw</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const line = raw.split(&quot;\\r&quot;).join(&quot;&quot;).trim()\" numlines=\"1\" declaredvars=\"line\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"DvFb~QP;Lm(;?C3;q~%#\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DvFb~QP;Lm(;?C3;q~%#\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"4)m-TU+K.AtkG_1KNIeR\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const op = (parts[1] || &quot;&quot;).toUpperCase()\" numlines=\"1\" declaredvars=\"op\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"4482\"><mutation name=\"pump\" functionid=\"c#Wg.,4A,#Eshh:z#Gbq\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"rt@H:(Wvo+VNR,}M6i.D\"></mutation></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></next></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></next></block></statement></block></xml>"]]}]}]},{"timestamp":1761155672095,"editorVersion":"8.0.17","changes":[{"type":"edited","filename":"pxt.json","patch":[{"start1":320,"length1":44,"diffs":[[1,""]]}]},{"type":"added","filename":"test.ts","value":"// tests go here; this will not be compiled when this package is used as an extension.\n"}]}],"snapshots":[{"timestamp":1760373307326,"editorVersion":"8.0.16","text":{"main.blocks":"<xml xmlns=\"http://www.w3.org/1999/xhtml\">\n  <block type=\"pxt-on-start\"></block>\n  <block type=\"device_forever\"></block>\n</xml>","main.ts":"\n","README.md":"","pxt.json":"{\n    \"name\": \"Untitled\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"radio\": \"*\",\n        \"microphone\": \"*\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\"\n    ],\n    \"additionalFilePaths\": []\n}\n"}},{"timestamp":1760397178320,"editorVersion":"8.0.16","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\".7-(GTJeTMT!80lik!Ey\">d</variable><variable id=\"08b_.n}f!9H@DdhvUqSz\">t</variable><variable id=\"e^%e@G*DBjgS4wnDU0cn\">q</variable><variable id=\"G%}5-q6JQb(j[;]eYJ)o\">P_OK</variable><variable id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</variable><variable id=\"5bjeW$0OVJ`?K)j-7vrF\">core</variable><variable id=\"b+Y_X^Af0C3;0F[C6c0O\">P_O</variable><variable id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</variable><variable id=\"s=?V7i/]NdU2Mnxz#CK9\">cmd</variable><variable id=\"5Jh7Y[04|{j,VJ6UsmHy\">line</variable><variable id=\"F,cup.!hp|Q:ZB*@Dngd\">QDEPTH</variable><variable id=\"p;Cl#3XpanZ{JL*)vS24\">P_S</variable><variable id=\"V#SB_p)9k!*}exvq=RD$\">ok</variable><variable id=\"^MXhC4U#3wu^Jh3@ba0}\">g</variable></variables><comment x=\"0\" y=\"0\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (MakeCode-safe) =====\nCommands (one per line, newline-terminated):\n:SEQ,OP,ARGS*\\n\nSEQ = 2-hex chosen by the app (00..FF)\nOP  = MV|SP|TL|TR|BK|HL|BZ|EC\nARGS (hex bytes, 00..FF):\nMV,left,right         -&gt; cuteBot.motors(left,right)   (0..100; negatives reverse)\nSP,00                 -&gt; stop\nTL,00                 -&gt; turn left (no args used)\nTR,00                 -&gt; turn right (no args used)\nBK,ss                 -&gt; backward via motors(-ss,-ss); default 50 if ss=0\nHL,01|00              -&gt; headlights on (white) / off\nHL,RR,GG,BB           -&gt; headlights set to RGB color\nBZ,HH,LL,DD           -&gt; buzzer tone; freq=(HH&lt;&lt;8)|LL Hz, duration=DD*10ms\nEC,00                 -&gt; echo/no-op (handy for latency tests)\n\nReplies (one line):\n:SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n\nTelemetry pushes (no SEQ):\n#DIST,cc              -&gt; ultrasonic distance in centimeters, ~2Hz\n</comment><comment x=\"0\" y=\"0\" w=\"480\" h=\"120\">\n---------- parser fills globals (avoids union/object return pitfalls) ----------\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">line</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_C = 0\" numlines=\"1\" declaredvars=\"P_C\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_B = 0\" numlines=\"1\" declaredvars=\"P_B\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_A = 0\" numlines=\"1\" declaredvars=\"P_A\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_O = &quot;&quot;\" numlines=\"1\" declaredvars=\"P_O\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">op</comment><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let P_S = 0\" numlines=\"1\" declaredvars=\"P_S\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">seq</comment><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: any[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"variables_set\"><field name=\"VAR\" id=\"F,cup.!hp|Q:ZB*@Dngd\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue (array of plain objects with short keys) ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: any) { if (q.length &gt;= QDEPTH) return false; q.push(c); return true }\" numlines=\"1\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: any, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;: // motors with speeds 0..100 (negatives reverse)\" line3=\"            cuteBot.motors(cmd.a, cmd.b)\" line4=\"            break\" line5=\"\" line6=\"        case &quot;SP&quot;: // stop\" line7=\"            cuteBot.stopcar()\" line8=\"            break\" line9=\"\" line10=\"        case &quot;TL&quot;: // turn left (no args)\" line11=\"            cuteBot.turnleft()\" line12=\"            break\" line13=\"\" line14=\"        case &quot;TR&quot;: // turn right (no args)\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"\" line18=\"        case &quot;BK&quot;: { // backward via negative motors\" line19=\"            const spd = cmd.a &gt; 0 ? cmd.a : 50\" line20=\"            cuteBot.motors(-spd, -spd)\" line21=\"            break\" line22=\"        }\" line23=\"\" line24=\"        case &quot;HL&quot;: {\" line25=\"            // If 3 args present (RGB): color = (a&lt;&lt;16)|(b&lt;&lt;8)|c\" line26=\"            // Note: pure black (0,0,0) equals &quot;off&quot;.\" line27=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line28=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line29=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line30=\"            } else {\" line31=\"                // Single-arg on/off (a = 0/!=0)\" line32=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\" line33=\"            }\" line34=\"            break\" line35=\"        }\" line36=\"\" line37=\"        case &quot;BZ&quot;: {\" line38=\"            // freq = (a&lt;&lt;8)|b (Hz), duration = c * 10 ms\" line39=\"            const freq = ((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF)\" line40=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line41=\"            if (dur &lt;= 0) dur = 100\" line42=\"            const f = Math.max(100, Math.min(5000, freq)) // clamp for reliability\" line43=\"            music.playTone(f, dur)\" line44=\"            break\" line45=\"        }\" line46=\"\" line47=\"        case &quot;EC&quot;:\" line48=\"            // echo (no motion)\" line49=\"            break\" line50=\"\" line51=\"        default:\" line52=\"            sendErr(cmd.s, 0x01) // unknown op\" line53=\"            done()\" line54=\"            return\" line55=\"    }\" line56=\"\" line57=\"    control.inBackground(() =&gt; {\" line58=\"        basic.pause(10)       // tiny yield; keeps BLE responsive\" line59=\"        sendAck(cmd.s)\" line60=\"        done()\" line61=\"    })\" line62=\"}\" numlines=\"63\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"925\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"5Jh7Y[04|{j,VJ6UsmHy\">line</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"J2Js*{d7Ay~6iiw.pqvG\"><arg name=\"line\" id=\"2hxvlaprobg65lqhb6zm6\" type=\"string\"></arg></mutation><value name=\"2hxvlaprobg65lqhb6zm6\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5Jh7Y[04|{j,VJ6UsmHy\">line</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></statement><next><block type=\"controls_if\"><comment pinned=\"false\" h=\"80\" w=\"160\">If worker+queue saturated -&gt; BUSY using parsed seq</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"e^%e@G*DBjgS4wnDU0cn\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"F,cup.!hp|Q:ZB*@Dngd\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"rM5MV5_T0pe]}zg390Uy\"><arg name=\"s\" id=\"tjrmyxvfvtij4pcxulfvb\" type=\"number\"></arg></mutation><value name=\"tjrmyxvfvtij4pcxulfvb\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"p;Cl#3XpanZ{JL*)vS24\">P_S</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const ok = qPush({ s: P_S, o: P_O, a: P_A, b: P_B, c: P_C })\" numlines=\"1\" declaredvars=\"ok\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"V#SB_p)9k!*}exvq=RD$\">ok</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"rM5MV5_T0pe]}zg390Uy\"><arg name=\"s\" id=\"tjrmyxvfvtij4pcxulfvb\" type=\"number\"></arg></mutation><value name=\"tjrmyxvfvtij4pcxulfvb\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"p;Cl#3XpanZ{JL*)vS24\">P_S</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"O7AUX+d2fd}i{9P2EZB~\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"every_interval\" x=\"1724\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry (distance ~2Hz) ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"^MXhC4U#3wu^Jh3@ba0}\">g</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"^MXhC4U#3wu^Jh3@ba0}\">g</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"2427\" y=\"20\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"yvgqisnpwumg1ranbu1w\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\".7-(GTJeTMT!80lik!Ey\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\".7-(GTJeTMT!80lik!Ey\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\".7-(GTJeTMT!80lik!Ey\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3388\" y=\"20\"><mutation name=\"parseHexByte\" functionid=\"j.i+D,Fw{]*C#Yzi,:r$\"><arg name=\"s\" id=\"qhg1wp64nenpb4qdlv7la\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"qhg1wp64nenpb4qdlv7la\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"08b_.n}f!9H@DdhvUqSz\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48      // '0'-'9'\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55 // 'A'-'F'\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"2972\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"6w0ncovd4akqfp3zkeyiye\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"425\" y=\"2972\"><mutation name=\"sendAck\" functionid=\"%oY^]/5T/^N?GFgEbQ}@\"><arg name=\"s\" id=\"inqtbnr61na2zz2xzlmgj\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"inqtbnr61na2zz2xzlmgj\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><value name=\"6w0ncovd4akqfp3zkeyiye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">s</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1058\" y=\"2972\"><mutation name=\"sendBusy\" functionid=\"rM5MV5_T0pe]}zg390Uy\"><arg name=\"s\" id=\"tjrmyxvfvtij4pcxulfvb\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"tjrmyxvfvtij4pcxulfvb\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><value name=\"6w0ncovd4akqfp3zkeyiye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">s</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1700\" y=\"2972\"><mutation name=\"sendErr\" functionid=\"1*qeqF35JqA40Y%;S5$-\"><arg name=\"s\" id=\"7gvo2pn1xmi4ou7q0oz1\" type=\"number\"></arg><arg name=\"ec\" id=\"dh98rvb4dwo1w1n16d4m\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"7gvo2pn1xmi4ou7q0oz1\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><value name=\"dh98rvb4dwo1w1n16d4m\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"0!Ws:-s~M2fVSa0!q|^1\"><arg name=\"line\" id=\"6w0ncovd4akqfp3zkeyiye\" type=\"string\"></arg></mutation><value name=\"6w0ncovd4akqfp3zkeyiye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">s</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"aCZqlu#Q?sF;wS`v[W1Z\"><arg name=\"n\" id=\"yvgqisnpwumg1ranbu1w\" type=\"number\"></arg></mutation><value name=\"yvgqisnpwumg1ranbu1w\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2089\" y=\"2972\"><mutation name=\"qPop\" functionid=\"PBsT)ZC|iA|xK%oUnQ@4\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"e^%e@G*DBjgS4wnDU0cn\">q</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2639\" y=\"2972\"><mutation name=\"parseLine\" functionid=\"J2Js*{d7Ay~6iiw.pqvG\"><arg name=\"line\" id=\"2hxvlaprobg65lqhb6zm6\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><value name=\"2hxvlaprobg65lqhb6zm6\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"variables_set\"><field name=\"VAR\" id=\"G%}5-q6JQb(j[;]eYJ)o\">P_OK</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5bjeW$0OVJ`?K)j-7vrF\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const s = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"s\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_S = isNaN(s) ? 0 : (s &amp; 0xFF)\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"b+Y_X^Af0C3;0F[C6c0O\">P_O</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_index_get\"><value name=\"LIST\"><block type=\"variables_get\"><field name=\"VAR\" id=\"@]V1_ZM5~h9QxxmBfl5%\">parts</field></block></value><value name=\"INDEX\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow></value></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_A = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_B = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"P_C = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"G%}5-q6JQb(j[;]eYJ)o\">P_OK</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3383\" y=\"2972\"><mutation name=\"pump\" functionid=\"O7AUX+d2fd}i{9P2EZB~\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"e^%e@G*DBjgS4wnDU0cn\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"0NXI!3+q-Fk]]7w_6;Rp\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"s=?V7i/]NdU2Mnxz#CK9\">cmd</field><comment pinned=\"false\" h=\"80\" w=\"160\">{ s,o,a,b,c }</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"PBsT)ZC|iA|xK%oUnQ@4\"></mutation></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (MakeCode TypeScript) =====\n// Line format from the app (newline-terminated):\n//   :SEQ,OP,ARGS*\\n\n// SEQ: 2 hex digits (00..FF) chosen by the app.\n// OP : MV|SP|TL|TR|BK|HL|BZ|EC\n//\n// ARGS (hex bytes 00..FF):\n//   MV,left,right         -> cuteBot.motors(left,right) (0..100; negatives reverse)\n//   SP,00                 -> stop\n//   TL,00                 -> turn left (no args used)\n//   TR,00                 -> turn right (no args used)\n//   BK,ss                 -> go backward via motors(-ss,-ss); if ss==0 use 50\n//   HL,01|00              -> headlights on (white) / off\n//   HL,RR,GG,BB           -> set headlights to RGB color\n//   BZ,HH,LL,DD           -> buzzer; freq=(HH<<8)|LL Hz, duration=DD*10 ms\n//   EC,00                 -> echo/no-op\n//\n// Replies (newline-terminated):\n//   :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n//\n// Telemetry (push, no SEQ):\n//   #DIST,cc              -> ultrasonic distance (cm) ~2 Hz\n\nbluetooth.startUartService()\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\n\nfunction parseHexByte(s: string) {\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48      // '0'..'9'\n        else if (c >= 65 && c <= 70) d = c - 55 // 'A'..'F'\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\n\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(seq: number) { send(\":\" + hex2(seq) + \",ACK\\n\") }\nfunction sendBusy(seq: number) { send(\":\" + hex2(seq) + \",BUSY\\n\") }\nfunction sendErr(seq: number, ec: number) { send(\":\" + hex2(seq) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue (plain array of tiny objects) ----------\nconst QDEPTH = 6\nconst q: any[] = []\nlet busy = false\n\nfunction qPush(c: any) {\n    if (q.length >= QDEPTH) return false\n    q.push(c)\n    return true\n}\nfunction qPop() {\n    return q.shift()\n}\n\n// ---------- parser -> returns tiny object or null ----------\nfunction parseLine(line: string) {\n    if (!line || line.length < 5) return null\n    if (line.charAt(0) != \":\") return null\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return null\n    const seq = parseInt(parts[0], 16)\n    const op = parts[1]\n    const a = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    const b = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    const c = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    return { s: isNaN(seq) ? 0 : (seq & 0xFF), o: op, a: a, b: b, c: c }\n}\n\n// ---------- execute one command (expects {s,o,a,b,c}) ----------\nfunction runOne(cmd: any, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\":\n            // motors with speeds (0..100; negatives reverse)\n            cuteBot.motors(cmd.a, cmd.b)\n            break\n\n        case \"SP\":\n            cuteBot.stopcar()\n            break\n\n        case \"TL\":\n            cuteBot.turnleft()\n            break\n\n        case \"TR\":\n            cuteBot.turnright()\n            break\n\n        case \"BK\": {\n            // No cuteBot.back(); simulate with negative motors\n            const spd = cmd.a > 0 ? cmd.a : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n\n        case \"HL\": {\n            // If b or c provided -> RGB; otherwise on/off via a\n            if (cmd.b > 0 || cmd.c > 0) {\n                const color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n            } else {\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\n            }\n            break\n        }\n\n        case \"BZ\": {\n            const freq = ((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            const f = Math.max(100, Math.min(5000, freq))\n            music.playTone(f, dur)\n            break\n        }\n\n        case \"EC\":\n            // echo/no-op\n            break\n\n        default:\n            sendErr(cmd.s, 0x01) // unknown op\n            done()\n            return\n    }\n\n    // Tiny yield so BLE stays responsive, then ACK\n    control.inBackground(() => {\n        basic.pause(10)\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd = qPop()\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive (line-oriented) ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const line = bluetooth.uartReadUntil(\"\\n\")\n    const cmd = parseLine(line)\n    if (!cmd) return\n\n    // Backpressure if worker+queue are saturated\n    if (busy && q.length >= QDEPTH) { sendBusy(cmd.s); return }\n\n    if (!qPush(cmd)) { sendBusy(cmd.s); return }\n    pump()\n})\n\n// ---------- telemetry (distance ~2 Hz) ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1760400616746,"editorVersion":"8.0.16","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"lno}ys6DHuT~H03AWe,R\">d</variable><variable id=\"1CWJH`,SF,A5j,cf|_CL\">t</variable><variable id=\"6-g#.tt=*!fyu]D,Dnjx\">q</variable><variable id=\"FTxZiThGpiPy;|A9g~FZ\">parts</variable><variable id=\"*wW6=LR{;,|XV.oPbg~,\">core</variable><variable id=\"{hmQr2d.Nm9!dtqNn.22\">op</variable><variable id=\"DV6qIB+datZD}eTQN5vA\">busy</variable><variable id=\"Y^~@)cjKV1jj3mL^^(xt\">cmd</variable><variable id=\"O!wAn+7.TfFb@}hOEO1{\">line</variable><variable id=\"ZB}!efnh*#q),[zrO3Lo\">cmd2</variable><variable id=\"awJrzd*eK%W]PArb{AVY\">QDEPTH</variable><variable id=\"C`%0lp^G=3B]Bd$Xoz)Z\">h</variable></variables><comment x=\"0\" y=\"0\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (MakeCode TypeScript) =====\nLine format from the app (newline-terminated):\n:SEQ,OP,ARGS*\\n\nSEQ: 2 hex digits (00..FF) chosen by the app.\nOP : MV|SP|TL|TR|BK|HL|BZ|EC\n\nARGS (hex bytes 00..FF):\nMV,left,right         -&gt; cuteBot.motors(left,right) (0..100; negatives reverse)\nSP,00                 -&gt; stop\nTL,00                 -&gt; turn left (no args used)\nTR,00                 -&gt; turn right (no args used)\nBK,ss                 -&gt; go backward via motors(-ss,-ss); if ss==0 use 50\nHL,01|00              -&gt; headlights on (white) / off\nHL,RR,GG,BB           -&gt; set headlights to RGB color\nBZ,HH,LL,DD           -&gt; buzzer; freq=(HH&lt;&lt;8)|LL Hz, duration=DD*10 ms\nEC,00                 -&gt; echo/no-op\n\nReplies (newline-terminated):\n:SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n\nTelemetry (push, no SEQ):\n#DIST,cc              -&gt; ultrasonic distance (cm) ~2 Hz\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">line</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: any[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"variables_set\"><field name=\"VAR\" id=\"awJrzd*eK%W]PArb{AVY\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue (plain array of tiny objects) ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: any) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: any, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;:\" line3=\"            // motors with speeds (0..100; negatives reverse)\" line4=\"            cuteBot.motors(cmd.a, cmd.b)\" line5=\"            break\" line6=\"\" line7=\"        case &quot;SP&quot;:\" line8=\"            cuteBot.stopcar()\" line9=\"            break\" line10=\"\" line11=\"        case &quot;TL&quot;:\" line12=\"            cuteBot.turnleft()\" line13=\"            break\" line14=\"\" line15=\"        case &quot;TR&quot;:\" line16=\"            cuteBot.turnright()\" line17=\"            break\" line18=\"\" line19=\"        case &quot;BK&quot;: {\" line20=\"            // No cuteBot.back(); simulate with negative motors\" line21=\"            const spd = cmd.a &gt; 0 ? cmd.a : 50\" line22=\"            cuteBot.motors(-spd, -spd)\" line23=\"            break\" line24=\"        }\" line25=\"\" line26=\"        case &quot;HL&quot;: {\" line27=\"            // If b or c provided -&gt; RGB; otherwise on/off via a\" line28=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line29=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line30=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line31=\"            } else {\" line32=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\" line33=\"            }\" line34=\"            break\" line35=\"        }\" line36=\"\" line37=\"        case &quot;BZ&quot;: {\" line38=\"            const freq = ((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF)\" line39=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line40=\"            if (dur &lt;= 0) dur = 100\" line41=\"            const g = Math.max(100, Math.min(5000, freq))\" line42=\"            music.playTone(g, dur)\" line43=\"            break\" line44=\"        }\" line45=\"\" line46=\"        case &quot;EC&quot;:\" line47=\"            // echo/no-op\" line48=\"            break\" line49=\"\" line50=\"        default:\" line51=\"            sendErr(cmd.s, 0x01) // unknown op\" line52=\"            done()\" line53=\"            return\" line54=\"    }\" line55=\"\" line56=\"    // Tiny yield so BLE stays responsive, then ACK\" line57=\"    control.inBackground(() =&gt; {\" line58=\"        basic.pause(10)\" line59=\"        sendAck(cmd.s)\" line60=\"        done()\" line61=\"    })\" line62=\"}\" numlines=\"63\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"925\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive (line-oriented) ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"O!wAn+7.TfFb@}hOEO1{\">line</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"ZB}!efnh*#q),[zrO3Lo\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"2BSq[|_Rvn/RAES2$0/|\"><arg name=\"line\" id=\"gliobn4e6uol4s9t262b\" type=\"string\"></arg></mutation><value name=\"gliobn4e6uol4s9t262b\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"O!wAn+7.TfFb@}hOEO1{\">line</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"ZB}!efnh*#q),[zrO3Lo\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></statement><next><block type=\"controls_if\"><comment pinned=\"false\" h=\"80\" w=\"160\">Backpressure if worker+queue are saturated</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DV6qIB+datZD}eTQN5vA\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6-g#.tt=*!fyu]D,Dnjx\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"awJrzd*eK%W]PArb{AVY\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"dd[Y}UfsYrwlncq2==a.\"><arg name=\"seq\" id=\"v9omobno64h281o3zludk\" type=\"number\"></arg></mutation><value name=\"v9omobno64h281o3zludk\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"dd[Y}UfsYrwlncq2==a.\"><arg name=\"seq\" id=\"v9omobno64h281o3zludk\" type=\"number\"></arg></mutation><value name=\"v9omobno64h281o3zludk\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"#S]2r4Kq4Bb+*9sz|8`!\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"every_interval\" x=\"1724\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry (distance ~2 Hz) ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"C`%0lp^G=3B]Bd$Xoz)Z\">h</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"C`%0lp^G=3B]Bd$Xoz)Z\">h</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"2427\" y=\"20\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"8u93u3a9e1f8gy9nwgn7n\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"lno}ys6DHuT~H03AWe,R\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"lno}ys6DHuT~H03AWe,R\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"lno}ys6DHuT~H03AWe,R\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3388\" y=\"20\"><mutation name=\"parseHexByte\" functionid=\"=3?UD5~8o67(Uf~vO!ld\"><arg name=\"s\" id=\"c4397aara9l78lgki7nf9\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"c4397aara9l78lgki7nf9\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"1CWJH`,SF,A5j,cf|_CL\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48      // '0'..'9'\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55 // 'A'..'F'\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"2972\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"dd7bju7v9tsgtn8xbwfpg\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"425\" y=\"2972\"><mutation name=\"sendAck\" functionid=\"qbOLKYbQgz1J]rA5sHO3\"><arg name=\"seq\" id=\"1qdfyoitwcgo9hw0ykrkam\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"1qdfyoitwcgo9hw0ykrkam\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><value name=\"dd7bju7v9tsgtn8xbwfpg\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1058\" y=\"2972\"><mutation name=\"sendBusy\" functionid=\"dd[Y}UfsYrwlncq2==a.\"><arg name=\"seq\" id=\"v9omobno64h281o3zludk\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"v9omobno64h281o3zludk\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><value name=\"dd7bju7v9tsgtn8xbwfpg\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1700\" y=\"2972\"><mutation name=\"sendErr\" functionid=\"sZn=jS?brVY]~n~Ts5Z#\"><arg name=\"seq\" id=\"sm0gy0z7fb01yknzm6b3f\" type=\"number\"></arg><arg name=\"ec\" id=\"0fmp897lbit350hrs8qa\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"sm0gy0z7fb01yknzm6b3f\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"0fmp897lbit350hrs8qa\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><value name=\"dd7bju7v9tsgtn8xbwfpg\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2089\" y=\"2972\"><mutation name=\"qPop\" functionid=\"?_To^xv11/}Wh6m^SD:N\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6-g#.tt=*!fyu]D,Dnjx\">q</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2639\" y=\"2972\"><mutation name=\"parseLine\" functionid=\"2BSq[|_Rvn/RAES2$0/|\"><arg name=\"line\" id=\"gliobn4e6uol4s9t262b\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser -&gt; returns tiny object or null ----------</comment><value name=\"gliobn4e6uol4s9t262b\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"FTxZiThGpiPy;|A9g~FZ\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"*wW6=LR{;,|XV.oPbg~,\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"FTxZiThGpiPy;|A9g~FZ\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"{hmQr2d.Nm9!dtqNn.22\">op</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_index_get\"><value name=\"LIST\"><block type=\"variables_get\"><field name=\"VAR\" id=\"FTxZiThGpiPy;|A9g~FZ\">parts</field></block></value><value name=\"INDEX\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow></value></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3383\" y=\"2972\"><mutation name=\"pump\" functionid=\"#S]2r4Kq4Bb+*9sz|8`!\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DV6qIB+datZD}eTQN5vA\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6-g#.tt=*!fyu]D,Dnjx\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"DV6qIB+datZD}eTQN5vA\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"Y^~@)cjKV1jj3mL^^(xt\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"?_To^xv11/}Wh6m^SD:N\"></mutation></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (MakeCode-safe) =====\n// Commands (one per line, newline-terminated):\n//   :SEQ,OP,ARGS*\\n\n// SEQ = 2-hex chosen by the app (00..FF)\n// OP  = MV|SP|TL|TR|BK|HL|BZ|EC\n// ARGS (hex bytes, 00..FF):\n//   MV,left,right         -> cuteBot.motors(left,right)   (0..100; negatives reverse)\n//   SP,00                 -> stop\n//   TL,00                 -> turn left (no args used)\n//   TR,00                 -> turn right (no args used)\n//   BK,ss                 -> backward via motors(-ss,-ss); default 50 if ss=0\n//   HL,01|00              -> headlights on (white) / off\n//   HL,RR,GG,BB           -> headlights set to RGB color\n//   BZ,HH,LL,DD           -> buzzer tone; freq=(HH<<8)|LL Hz, duration=DD*10ms\n//   EC,00                 -> echo/no-op (handy for latency tests)\n//\n// Replies (one line):\n//   :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n//\n// Telemetry pushes (no SEQ):\n//   #DIST,cc              -> ultrasonic distance in centimeters, ~2Hz\n\nbluetooth.startUartService()\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\nfunction parseHexByte(s: string) {\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48      // '0'-'9'\n        else if (c >= 65 && c <= 70) d = c - 55 // 'A'-'F'\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(s: number) { send(\":\" + hex2(s) + \",ACK\\n\") }\nfunction sendBusy(s: number) { send(\":\" + hex2(s) + \",BUSY\\n\") }\nfunction sendErr(s: number, ec: number) { send(\":\" + hex2(s) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue (array of plain objects with short keys) ----------\nconst QDEPTH = 6\nconst q: any[] = []\nlet busy = false\nfunction qPush(c: any) { if (q.length >= QDEPTH) return false; q.push(c); return true }\nfunction qPop() { return q.shift() }\n\n// ---------- parser fills globals (avoids union/object return pitfalls) ----------\nlet P_OK = false\nlet P_S = 0      // seq\nlet P_O = \"\"     // op\nlet P_A = 0\nlet P_B = 0\nlet P_C = 0\nfunction parseLine(line: string): boolean {\n    P_OK = false\n    if (!line || line.length < 5) return false\n    if (line.charAt(0) != \":\") return false\n\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return false\n\n    const s = parseInt(parts[0], 16)\n    P_S = isNaN(s) ? 0 : (s & 0xFF)\n    P_O = parts[1]\n    P_A = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    P_B = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    P_C = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    P_OK = true\n    return true\n}\n\n// ---------- execute one command (expects {s,o,a,b,c}) ----------\nfunction runOne(cmd: any, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\": // motors with speeds 0..100 (negatives reverse)\n            cuteBot.motors(cmd.a, cmd.b)\n            break\n\n        case \"SP\": // stop\n            cuteBot.stopcar()\n            break\n\n        case \"TL\": // turn left (no args)\n            cuteBot.turnleft()\n            break\n\n        case \"TR\": // turn right (no args)\n            cuteBot.turnright()\n            break\n\n        case \"BK\": { // backward via negative motors\n            const spd = cmd.a > 0 ? cmd.a : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n\n        case \"HL\": {\n            // If 3 args present (RGB): color = (a<<16)|(b<<8)|c\n            // Note: pure black (0,0,0) equals \"off\".\n            if (cmd.b > 0 || cmd.c > 0) {\n                const color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n            } else {\n                // Single-arg on/off (a = 0/!=0)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\n            }\n            break\n        }\n\n        case \"BZ\": {\n            // freq = (a<<8)|b (Hz), duration = c * 10 ms\n            const freq = ((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            const f = Math.max(100, Math.min(5000, freq)) // clamp for reliability\n            music.playTone(f, dur)\n            break\n        }\n\n        case \"EC\":\n            // echo (no motion)\n            break\n\n        default:\n            sendErr(cmd.s, 0x01) // unknown op\n            done()\n            return\n    }\n\n    control.inBackground(() => {\n        basic.pause(10)       // tiny yield; keeps BLE responsive\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd = qPop() // { s,o,a,b,c }\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const line = bluetooth.uartReadUntil(\"\\n\")\n    if (!parseLine(line)) return\n\n    // If worker+queue saturated -> BUSY using parsed seq\n    if (busy && q.length >= QDEPTH) { sendBusy(P_S); return }\n\n    // Enqueue a tiny object (no classes/generics)\n    const ok = qPush({ s: P_S, o: P_O, a: P_A, b: P_B, c: P_C })\n    if (!ok) { sendBusy(P_S); return }\n\n    pump()\n})\n\n// ---------- telemetry (distance ~2Hz) ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1760550222107,"editorVersion":"8.0.16","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"lno}ys6DHuT~H03AWe,R\">d</variable><variable id=\"1CWJH`,SF,A5j,cf|_CL\">t</variable><variable id=\"6-g#.tt=*!fyu]D,Dnjx\">q</variable><variable id=\"FTxZiThGpiPy;|A9g~FZ\">parts</variable><variable id=\"*wW6=LR{;,|XV.oPbg~,\">core</variable><variable id=\"{hmQr2d.Nm9!dtqNn.22\">op</variable><variable id=\"DV6qIB+datZD}eTQN5vA\">busy</variable><variable id=\"Y^~@)cjKV1jj3mL^^(xt\">cmd</variable><variable id=\"O!wAn+7.TfFb@}hOEO1{\">line</variable><variable id=\"ZB}!efnh*#q),[zrO3Lo\">cmd2</variable><variable id=\"awJrzd*eK%W]PArb{AVY\">QDEPTH</variable><variable id=\"C`%0lp^G=3B]Bd$Xoz)Z\">h</variable></variables><comment x=\"0\" y=\"0\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (MakeCode TypeScript) =====\nLine format from the app (newline-terminated):\n:SEQ,OP,ARGS*\\n\nSEQ: 2 hex digits (00..FF) chosen by the app.\nOP : MV|SP|TL|TR|BK|HL|BZ|EC\n\nARGS (hex bytes 00..FF):\nMV,left,right         -&gt; cuteBot.motors(left,right) (0..100; negatives reverse)\nSP,00                 -&gt; stop\nTL,00                 -&gt; turn left (no args used)\nTR,00                 -&gt; turn right (no args used)\nBK,ss                 -&gt; go backward via motors(-ss,-ss); if ss==0 use 50\nHL,01|00              -&gt; headlights on (white) / off\nHL,RR,GG,BB           -&gt; set headlights to RGB color\nBZ,HH,LL,DD           -&gt; buzzer; freq=(HH&lt;&lt;8)|LL Hz, duration=DD*10 ms\nEC,00                 -&gt; echo/no-op\n\nReplies (newline-terminated):\n:SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n\nTelemetry (push, no SEQ):\n#DIST,cc              -&gt; ultrasonic distance (cm) ~2 Hz\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">line</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: any[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"variables_set\"><field name=\"VAR\" id=\"awJrzd*eK%W]PArb{AVY\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue (plain array of tiny objects) ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: any) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: any, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;:\" line3=\"            // motors with speeds (0..100; negatives reverse)\" line4=\"            cuteBot.motors(cmd.a, cmd.b)\" line5=\"            break\" line6=\"\" line7=\"        case &quot;SP&quot;:\" line8=\"            cuteBot.stopcar()\" line9=\"            break\" line10=\"\" line11=\"        case &quot;TL&quot;:\" line12=\"            cuteBot.turnleft()\" line13=\"            break\" line14=\"\" line15=\"        case &quot;TR&quot;:\" line16=\"            cuteBot.turnright()\" line17=\"            break\" line18=\"\" line19=\"        case &quot;BK&quot;: {\" line20=\"            // No cuteBot.back(); simulate with negative motors\" line21=\"            const spd = cmd.a &gt; 0 ? cmd.a : 50\" line22=\"            cuteBot.motors(-spd, -spd)\" line23=\"            break\" line24=\"        }\" line25=\"\" line26=\"        case &quot;HL&quot;: {\" line27=\"            // If b or c provided -&gt; RGB; otherwise on/off via a\" line28=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line29=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line30=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line31=\"            } else {\" line32=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, cmd.a ? 0xFFFFFF : 0x000000)\" line33=\"            }\" line34=\"            break\" line35=\"        }\" line36=\"\" line37=\"        case &quot;BZ&quot;: {\" line38=\"            const freq = ((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF)\" line39=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line40=\"            if (dur &lt;= 0) dur = 100\" line41=\"            const g = Math.max(100, Math.min(5000, freq))\" line42=\"            music.playTone(g, dur)\" line43=\"            break\" line44=\"        }\" line45=\"\" line46=\"        case &quot;EC&quot;:\" line47=\"            // echo/no-op\" line48=\"            break\" line49=\"\" line50=\"        default:\" line51=\"            sendErr(cmd.s, 0x01) // unknown op\" line52=\"            done()\" line53=\"            return\" line54=\"    }\" line55=\"\" line56=\"    // Tiny yield so BLE stays responsive, then ACK\" line57=\"    control.inBackground(() =&gt; {\" line58=\"        basic.pause(10)\" line59=\"        sendAck(cmd.s)\" line60=\"        done()\" line61=\"    })\" line62=\"}\" numlines=\"63\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"925\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive (line-oriented) ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"O!wAn+7.TfFb@}hOEO1{\">line</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"ZB}!efnh*#q),[zrO3Lo\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"2BSq[|_Rvn/RAES2$0/|\"><arg name=\"line\" id=\"gliobn4e6uol4s9t262b\" type=\"string\"></arg></mutation><value name=\"gliobn4e6uol4s9t262b\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"O!wAn+7.TfFb@}hOEO1{\">line</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"ZB}!efnh*#q),[zrO3Lo\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></statement><next><block type=\"controls_if\"><comment pinned=\"false\" h=\"80\" w=\"160\">Backpressure if worker+queue are saturated</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DV6qIB+datZD}eTQN5vA\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6-g#.tt=*!fyu]D,Dnjx\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"awJrzd*eK%W]PArb{AVY\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"dd[Y}UfsYrwlncq2==a.\"><arg name=\"seq\" id=\"v9omobno64h281o3zludk\" type=\"number\"></arg></mutation><value name=\"v9omobno64h281o3zludk\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"dd[Y}UfsYrwlncq2==a.\"><arg name=\"seq\" id=\"v9omobno64h281o3zludk\" type=\"number\"></arg></mutation><value name=\"v9omobno64h281o3zludk\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"#S]2r4Kq4Bb+*9sz|8`!\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"every_interval\" x=\"1724\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry (distance ~2 Hz) ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"C`%0lp^G=3B]Bd$Xoz)Z\">h</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"C`%0lp^G=3B]Bd$Xoz)Z\">h</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"2427\" y=\"20\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"8u93u3a9e1f8gy9nwgn7n\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"lno}ys6DHuT~H03AWe,R\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"lno}ys6DHuT~H03AWe,R\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"lno}ys6DHuT~H03AWe,R\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3388\" y=\"20\"><mutation name=\"parseHexByte\" functionid=\"=3?UD5~8o67(Uf~vO!ld\"><arg name=\"s\" id=\"c4397aara9l78lgki7nf9\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"c4397aara9l78lgki7nf9\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"1CWJH`,SF,A5j,cf|_CL\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48      // '0'..'9'\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55 // 'A'..'F'\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"2972\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"dd7bju7v9tsgtn8xbwfpg\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"425\" y=\"2972\"><mutation name=\"sendAck\" functionid=\"qbOLKYbQgz1J]rA5sHO3\"><arg name=\"seq\" id=\"1qdfyoitwcgo9hw0ykrkam\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"1qdfyoitwcgo9hw0ykrkam\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><value name=\"dd7bju7v9tsgtn8xbwfpg\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1058\" y=\"2972\"><mutation name=\"sendBusy\" functionid=\"dd[Y}UfsYrwlncq2==a.\"><arg name=\"seq\" id=\"v9omobno64h281o3zludk\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"v9omobno64h281o3zludk\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><value name=\"dd7bju7v9tsgtn8xbwfpg\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1700\" y=\"2972\"><mutation name=\"sendErr\" functionid=\"sZn=jS?brVY]~n~Ts5Z#\"><arg name=\"seq\" id=\"sm0gy0z7fb01yknzm6b3f\" type=\"number\"></arg><arg name=\"ec\" id=\"0fmp897lbit350hrs8qa\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"sm0gy0z7fb01yknzm6b3f\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"0fmp897lbit350hrs8qa\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"]_gjf*|D}?R-xE[2){n#\"><arg name=\"line\" id=\"dd7bju7v9tsgtn8xbwfpg\" type=\"string\"></arg></mutation><value name=\"dd7bju7v9tsgtn8xbwfpg\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"[u4N.=ZXW+gB,47DzB8B\"><arg name=\"n\" id=\"8u93u3a9e1f8gy9nwgn7n\" type=\"number\"></arg></mutation><value name=\"8u93u3a9e1f8gy9nwgn7n\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2089\" y=\"2972\"><mutation name=\"qPop\" functionid=\"?_To^xv11/}Wh6m^SD:N\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6-g#.tt=*!fyu]D,Dnjx\">q</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2639\" y=\"2972\"><mutation name=\"parseLine\" functionid=\"2BSq[|_Rvn/RAES2$0/|\"><arg name=\"line\" id=\"gliobn4e6uol4s9t262b\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser -&gt; returns tiny object or null ----------</comment><value name=\"gliobn4e6uol4s9t262b\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"FTxZiThGpiPy;|A9g~FZ\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"*wW6=LR{;,|XV.oPbg~,\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"FTxZiThGpiPy;|A9g~FZ\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"{hmQr2d.Nm9!dtqNn.22\">op</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_index_get\"><value name=\"LIST\"><block type=\"variables_get\"><field name=\"VAR\" id=\"FTxZiThGpiPy;|A9g~FZ\">parts</field></block></value><value name=\"INDEX\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow></value></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3383\" y=\"2972\"><mutation name=\"pump\" functionid=\"#S]2r4Kq4Bb+*9sz|8`!\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DV6qIB+datZD}eTQN5vA\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6-g#.tt=*!fyu]D,Dnjx\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"DV6qIB+datZD}eTQN5vA\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"Y^~@)cjKV1jj3mL^^(xt\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"?_To^xv11/}Wh6m^SD:N\"></mutation></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (TypeScript) =====\n// Commands from app (newline-terminated): :SEQ,OP,ARGS*\\n\n// SEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n//\n// ARGS:\n//   MV,left,right         -> motors(left,right) 0..100 (negatives reverse)\n//   SP,00                 -> stop\n//   TL,00 / TR,00         -> turn left/right\n//   BK,ss                 -> backward via motors(-ss,-ss); default 50\n//   HL,01|00              -> headlights on/off (white)\n//   HL,RR,GG,BB           -> headlights to RGB color\n//   BZ,HH,LL,DD           -> buzzer freq=(HH<<8)|LL Hz, dur=DD*10ms\n//   EC,00                 -> echo/no-op\n//\n// Replies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n// Telemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n\nbluetooth.startUartService()\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\n\nfunction parseHexByte(s: string) {\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48\n        else if (c >= 65 && c <= 70) d = c - 55\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\n\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(seq: number) { send(\":\" + hex2(seq) + \",ACK\\n\") }\nfunction sendBusy(seq: number) { send(\":\" + hex2(seq) + \",BUSY\\n\") }\nfunction sendErr(seq: number, ec: number) { send(\":\" + hex2(seq) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue ----------\nconst QDEPTH = 6\nconst q: any[] = []\nlet busy = false\n\nfunction qPush(c: any) {\n    if (q.length >= QDEPTH) return false\n    q.push(c)\n    return true\n}\nfunction qPop() {\n    return q.shift()\n}\n\n// ---------- parser ----------\nfunction parseLine(line: string) {\n    if (!line || line.length < 5) return null\n    if (line.charAt(0) != \":\") return null\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return null\n    const seq = parseInt(parts[0], 16)\n    const op = parts[1]\n    const a = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    const b = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    const c = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    return { s: isNaN(seq) ? 0 : (seq & 0xFF), o: op, a: a, b: b, c: c }\n}\n\n// ---------- executor ----------\nfunction runOne(cmd: any, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\":\n            cuteBot.motors(cmd.a, cmd.b)\n            break\n\n        case \"SP\":\n            cuteBot.stopcar()\n            break\n\n        case \"TL\":\n            cuteBot.turnleft()\n            break\n\n        case \"TR\":\n            cuteBot.turnright()\n            break\n\n        case \"BK\": {\n            const spd = cmd.a > 0 ? cmd.a : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n\n        case \"HL\": {\n            let color: number\n            if (cmd.b > 0 || cmd.c > 0) {\n                color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n            } else {\n                color = cmd.a ? 0xFFFFFF : 0x000000\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n            }\n            // telemetry push: LED color\n            const rr = hex2((color >> 16) & 0xFF)\n            const gg = hex2((color >> 8) & 0xFF)\n            const bb = hex2(color & 0xFF)\n            send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            break\n        }\n\n        case \"BZ\": {\n            const freq = ((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            const f = Math.max(100, Math.min(5000, freq))\n            music.playTone(f, dur)\n            // push telemetry once tone completes\n            control.inBackground(() => {\n                basic.pause(dur)\n                send(\"#BUZ,done\\n\")\n            })\n            break\n        }\n\n        case \"EC\":\n            break\n\n        default:\n            sendErr(cmd.s, 0x01)\n            done()\n            return\n    }\n\n    control.inBackground(() => {\n        basic.pause(10)\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd = qPop()\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const line = bluetooth.uartReadUntil(\"\\n\")\n    const cmd = parseLine(line)\n    if (!cmd) return\n    if (busy && q.length >= QDEPTH) { sendBusy(cmd.s); return }\n    if (!qPush(cmd)) { sendBusy(cmd.s); return }\n    pump()\n})\n\n// ---------- telemetry loop ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1760731284562,"editorVersion":"8.0.17","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"GZDc:fr9y[5w`ny3U_7A\">d</variable><variable id=\"_Arm@F]Fn{VIpeLZKRn-\">t</variable><variable id=\"6{3$gV+`@KU$A-u#aArc\">q</variable><variable id=\"}y^Fw,Xl4f9=GXAE-s1,\">parts</variable><variable id=\"mDi+`%{psxqn8kHzS}Oy\">core</variable><variable id=\"@q}1nfKb#z-k=59PQFwt\">op</variable><variable id=\"l9UwK*q.KCl51x^fT_?q\">busy</variable><variable id=\"8ab:ann;kD~(m!uw[R?b\">cmd</variable><variable id=\"G{{KukE78@HhPg,TrSux\">line</variable><variable id=\"UDfRKS+@eR+F3jZ@8x!{\">cmd2</variable><variable id=\"-i-_IqU+u:km=%Z:Clel\">QDEPTH</variable><variable id=\"g=+Qpl?sVR[C2({6_(*|\">h</variable></variables><comment x=\"0\" y=\"0\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (TypeScript) =====\nCommands from app (newline-terminated): :SEQ,OP,ARGS*\\n\nSEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n\nARGS:\nMV,left,right         -&gt; motors(left,right) 0..100 (negatives reverse)\nSP,00                 -&gt; stop\nTL,00 / TR,00         -&gt; turn left/right\nBK,ss                 -&gt; backward via motors(-ss,-ss); default 50\nHL,01|00              -&gt; headlights on/off (white)\nHL,RR,GG,BB           -&gt; headlights to RGB color\nBZ,HH,LL,DD           -&gt; buzzer freq=(HH&lt;&lt;8)|LL Hz, dur=DD*10ms\nEC,00                 -&gt; echo/no-op\n\nReplies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\nTelemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">line</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: any[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"variables_set\"><field name=\"VAR\" id=\"-i-_IqU+u:km=%Z:Clel\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: any) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: any, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;:\" line3=\"            cuteBot.motors(cmd.a, cmd.b)\" line4=\"            break\" line5=\"\" line6=\"        case &quot;SP&quot;:\" line7=\"            cuteBot.stopcar()\" line8=\"            break\" line9=\"\" line10=\"        case &quot;TL&quot;:\" line11=\"            cuteBot.turnleft()\" line12=\"            break\" line13=\"\" line14=\"        case &quot;TR&quot;:\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"\" line18=\"        case &quot;BK&quot;: {\" line19=\"            const spd = cmd.a &gt; 0 ? cmd.a : 50\" line20=\"            cuteBot.motors(-spd, -spd)\" line21=\"            break\" line22=\"        }\" line23=\"\" line24=\"        case &quot;HL&quot;: {\" line25=\"            let color: number\" line26=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line27=\"                color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line28=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line29=\"            } else {\" line30=\"                color = cmd.a ? 0xFFFFFF : 0x000000\" line31=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line32=\"            }\" line33=\"            // telemetry push: LED color\" line34=\"            const rr = hex2((color &gt;&gt; 16) &amp; 0xFF)\" line35=\"            const gg = hex2((color &gt;&gt; 8) &amp; 0xFF)\" line36=\"            const bb = hex2(color &amp; 0xFF)\" line37=\"            send(&quot;#LED,&quot; + rr + gg + bb + &quot;\\n&quot;)\" line38=\"            break\" line39=\"        }\" line40=\"\" line41=\"        case &quot;BZ&quot;: {\" line42=\"            const freq = ((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF)\" line43=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line44=\"            if (dur &lt;= 0) dur = 100\" line45=\"            const g = Math.max(100, Math.min(5000, freq))\" line46=\"            music.playTone(g, dur)\" line47=\"            // push telemetry once tone completes\" line48=\"            control.inBackground(() =&gt; {\" line49=\"                basic.pause(dur)\" line50=\"                send(&quot;#BUZ,done\\n&quot;)\" line51=\"            })\" line52=\"            break\" line53=\"        }\" line54=\"\" line55=\"        case &quot;EC&quot;:\" line56=\"            break\" line57=\"\" line58=\"        default:\" line59=\"            sendErr(cmd.s, 0x01)\" line60=\"            done()\" line61=\"            return\" line62=\"    }\" line63=\"\" line64=\"    control.inBackground(() =&gt; {\" line65=\"        basic.pause(10)\" line66=\"        sendAck(cmd.s)\" line67=\"        done()\" line68=\"    })\" line69=\"}\" numlines=\"70\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"925\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"G{{KukE78@HhPg,TrSux\">line</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"UDfRKS+@eR+F3jZ@8x!{\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"PA|ovoI}uznn.9H|*jrb\"><arg name=\"line\" id=\"hxoyucm5ek2dyo0jqc1a\" type=\"string\"></arg></mutation><value name=\"hxoyucm5ek2dyo0jqc1a\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"G{{KukE78@HhPg,TrSux\">line</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"UDfRKS+@eR+F3jZ@8x!{\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"l9UwK*q.KCl51x^fT_?q\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6{3$gV+`@KU$A-u#aArc\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"-i-_IqU+u:km=%Z:Clel\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"V.NmAL}Zn~*vGM#%m)$A\"><arg name=\"seq\" id=\"840uhr97tpnoda9qnn1s\" type=\"number\"></arg></mutation><value name=\"840uhr97tpnoda9qnn1s\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"V.NmAL}Zn~*vGM#%m)$A\"><arg name=\"seq\" id=\"840uhr97tpnoda9qnn1s\" type=\"number\"></arg></mutation><value name=\"840uhr97tpnoda9qnn1s\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"R({X6_=Ia!lGHR,TL?].\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"every_interval\" x=\"1724\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry loop ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"g=+Qpl?sVR[C2({6_(*|\">h</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"g=+Qpl?sVR[C2({6_(*|\">h</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"2427\" y=\"20\"><mutation name=\"hex2\" functionid=\"T!I!y,Vo(AB`+3]8(,~u\"><arg name=\"n\" id=\"ea1lsfay74cujkqybg7ke\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"ea1lsfay74cujkqybg7ke\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"GZDc:fr9y[5w`ny3U_7A\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"GZDc:fr9y[5w`ny3U_7A\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"GZDc:fr9y[5w`ny3U_7A\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3388\" y=\"20\"><mutation name=\"parseHexByte\" functionid=\"_atp,Ky;9vd%J]kVg]v4\"><arg name=\"s\" id=\"y8tnm91frzf3g9b7denga\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"y8tnm91frzf3g9b7denga\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"_Arm@F]Fn{VIpeLZKRn-\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"2972\"><mutation name=\"send\" functionid=\"qI78~X*TpJZ.5=4TbsX?\"><arg name=\"line\" id=\"3c9kd3bxawexx0e4zkl8\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"3c9kd3bxawexx0e4zkl8\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"425\" y=\"2972\"><mutation name=\"sendAck\" functionid=\"HVbjAYxb]g*$j5$j-uE$\"><arg name=\"seq\" id=\"1j0rrkyiux68n2tomecst\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"1j0rrkyiux68n2tomecst\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"qI78~X*TpJZ.5=4TbsX?\"><arg name=\"line\" id=\"3c9kd3bxawexx0e4zkl8\" type=\"string\"></arg></mutation><value name=\"3c9kd3bxawexx0e4zkl8\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"T!I!y,Vo(AB`+3]8(,~u\"><arg name=\"n\" id=\"ea1lsfay74cujkqybg7ke\" type=\"number\"></arg></mutation><value name=\"ea1lsfay74cujkqybg7ke\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1058\" y=\"2972\"><mutation name=\"sendBusy\" functionid=\"V.NmAL}Zn~*vGM#%m)$A\"><arg name=\"seq\" id=\"840uhr97tpnoda9qnn1s\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"840uhr97tpnoda9qnn1s\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"qI78~X*TpJZ.5=4TbsX?\"><arg name=\"line\" id=\"3c9kd3bxawexx0e4zkl8\" type=\"string\"></arg></mutation><value name=\"3c9kd3bxawexx0e4zkl8\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"T!I!y,Vo(AB`+3]8(,~u\"><arg name=\"n\" id=\"ea1lsfay74cujkqybg7ke\" type=\"number\"></arg></mutation><value name=\"ea1lsfay74cujkqybg7ke\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"1700\" y=\"2972\"><mutation name=\"sendErr\" functionid=\"yRCM~wn5kfkU9frN03FZ\"><arg name=\"seq\" id=\"kdydjvcviqns412kq3zp\" type=\"number\"></arg><arg name=\"ec\" id=\"ht4fcbf8jjp7e5k5esp054\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"kdydjvcviqns412kq3zp\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"ht4fcbf8jjp7e5k5esp054\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"qI78~X*TpJZ.5=4TbsX?\"><arg name=\"line\" id=\"3c9kd3bxawexx0e4zkl8\" type=\"string\"></arg></mutation><value name=\"3c9kd3bxawexx0e4zkl8\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"T!I!y,Vo(AB`+3]8(,~u\"><arg name=\"n\" id=\"ea1lsfay74cujkqybg7ke\" type=\"number\"></arg></mutation><value name=\"ea1lsfay74cujkqybg7ke\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"T!I!y,Vo(AB`+3]8(,~u\"><arg name=\"n\" id=\"ea1lsfay74cujkqybg7ke\" type=\"number\"></arg></mutation><value name=\"ea1lsfay74cujkqybg7ke\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2089\" y=\"2972\"><mutation name=\"qPop\" functionid=\"si:3W6mC$h7+Nvrpm~j-\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6{3$gV+`@KU$A-u#aArc\">q</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2639\" y=\"2972\"><mutation name=\"parseLine\" functionid=\"PA|ovoI}uznn.9H|*jrb\"><arg name=\"line\" id=\"hxoyucm5ek2dyo0jqc1a\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser ----------</comment><value name=\"hxoyucm5ek2dyo0jqc1a\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"}y^Fw,Xl4f9=GXAE-s1,\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"mDi+`%{psxqn8kHzS}Oy\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"}y^Fw,Xl4f9=GXAE-s1,\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"@q}1nfKb#z-k=59PQFwt\">op</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_index_get\"><value name=\"LIST\"><block type=\"variables_get\"><field name=\"VAR\" id=\"}y^Fw,Xl4f9=GXAE-s1,\">parts</field></block></value><value name=\"INDEX\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow></value></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"3383\" y=\"2972\"><mutation name=\"pump\" functionid=\"R({X6_=Ia!lGHR,TL?].\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"l9UwK*q.KCl51x^fT_?q\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"6{3$gV+`@KU$A-u#aArc\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"l9UwK*q.KCl51x^fT_?q\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"8ab:ann;kD~(m!uw[R?b\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"si:3W6mC$h7+Nvrpm~j-\"></mutation></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (TypeScript) =====\n// Commands from app (newline-terminated): :SEQ,OP,ARGS*\\n\n// SEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n//\n// ARGS:\n//   MV,left,right         -> motors(left,right) -100..100 (negatives reverse)\n//   SP,00                 -> stop\n//   TL,00 / TR,00         -> turn left/right (instant)\n//   BK,ss                 -> backward via motors(-ss,-ss); default 50\n//   HL,01|00              -> headlights on/off (white)\n//   HL,RR,GG,BB           -> headlights to RGB color (0..FF each)\n//   BZ,HH,LL,DD           -> buzzer freq=(HH<<8)|LL Hz, dur=DD*10ms (DD=0->100ms)\n//   EC,00                 -> echo/no-op\n//\n// Replies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n// Telemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n\nbluetooth.startUartService()\n\n// ---------- UI feedback ----------\nlet bleConnected = false\n\nbluetooth.onBluetoothConnected(function () {\n    bleConnected = true\n    basic.showIcon(IconNames.Heart)\n})\n\nbluetooth.onBluetoothDisconnected(function () {\n    bleConnected = false\n    basic.clearScreen()\n    basic.showIcon(IconNames.SmallDiamond)\n})\n\n// --- Button A: show card name quickly ---\ninput.onButtonPressed(Button.A, function () {\n    // display BLE device name quickly\n    basic.showString(control.deviceName(), 50)\n    // restore icon based on BLE state\n    if (bleConnected) basic.showIcon(IconNames.Heart)\n    else basic.showIcon(IconNames.SmallDiamond)\n})\n\n// ---------- types ----------\ntype Cmd = { s: number, o: string, a: number, b: number, c: number }\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\n\nfunction parseHexByte(s: string) {\n    if (!s) return 0\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48\n        else if (c >= 65 && c <= 70) d = c - 55\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\n\nfunction clamp(v: number, lo: number, hi: number) {\n    return Math.max(lo, Math.min(hi, v))\n}\n\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(seq: number) { send(\":\" + hex2(seq) + \",ACK\\n\") }\nfunction sendBusy(seq: number) { send(\":\" + hex2(seq) + \",BUSY\\n\") }\nfunction sendErr(seq: number, ec: number) { send(\":\" + hex2(seq) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue ----------\nconst QDEPTH = 6\nconst q: Cmd[] = []\nlet busy = false\n\nfunction qPush(c: Cmd) {\n    if (q.length >= QDEPTH) return false\n    q.push(c)\n    return true\n}\nfunction qPop(): Cmd | null {\n    if (q.length == 0) return null\n    return q.shift()\n}\n\n// ---------- parser ----------\nfunction parseLine(raw: string): Cmd | null {\n    if (!raw) return null\n    // MakeCode-safe: String.replace doesn't take RegExp; use split/join\n    const line = raw.split(\"\\r\").join(\"\").trim()\n    if (line.length < 5) return null\n    if (line.charAt(0) != \":\") return null\n\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return null\n\n    const seq = parseInt(parts[0], 16)\n    const op = (parts[1] || \"\").toUpperCase()\n    const a = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    const b = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    const c = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    return { s: isNaN(seq) ? 0 : (seq & 0xFF), o: op, a: a, b: b, c: c }\n}\n\n// ---------- executor ----------\nfunction runOne(cmd: Cmd, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\": {\n            const L = clamp(cmd.a, -100, 100)\n            const R = clamp(cmd.b, -100, 100)\n            cuteBot.motors(L, R)\n            break\n        }\n        case \"SP\":\n            cuteBot.stopcar()\n            break\n        case \"TL\":\n            cuteBot.turnleft()\n            break\n        case \"TR\":\n            cuteBot.turnright()\n            break\n        case \"BK\": {\n            const spd = cmd.a > 0 ? clamp(cmd.a, 0, 100) : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n        case \"HL\": {\n            if (cmd.b > 0 || cmd.c > 0) {\n                const color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            } else {\n                const on = (cmd.a & 0xFF) != 0\n                const color = on ? 0xFFFFFF : 0x000000\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            }\n            break\n        }\n        case \"BZ\": {\n            const freq = clamp(((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF), 100, 5000)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            music.playTone(freq, dur)\n            control.inBackground(() => {\n                basic.pause(dur)\n                send(\"#BUZ,done\\n\")\n            })\n            break\n        }\n        case \"EC\":\n            break\n        default:\n            sendErr(cmd.s, 0x01)\n            done()\n            return\n    }\n\n    control.inBackground(() => {\n        basic.pause(10)\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd: Cmd | null = qPop()\n    if (!cmd) { busy = false; return }\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const raw = bluetooth.uartReadUntil(\"\\n\")\n    const cmd: Cmd | null = parseLine(raw)\n    if (!cmd) {\n        sendErr(0x00, 0x02)\n        return\n    }\n    if (busy && q.length >= QDEPTH) { sendBusy(cmd.s); return }\n    if (!qPush(cmd)) { sendBusy(cmd.s); return }\n    pump()\n})\n\n// ---------- telemetry loop ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1760993845420,"editorVersion":"8.0.17","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"Oa+yVNw89a[OSvNroCvG\">bleConnected</variable><variable id=\"]|Cw$0MdsXhIn7s[H5N7\">d</variable><variable id=\"wX8/pXHxT+GACX4a(kqv\">t</variable><variable id=\"T9{?QLa{9,CmNg(D4~$M\">q</variable><variable id=\"kZB@9Hz?-{r#)aRh$Dmn\">line</variable><variable id=\"NsNo8[tXuux-`D|Ebio?\">parts</variable><variable id=\"]yC2p.432V5M?4VcN?Yy\">core</variable><variable id=\"5r{RE!~MTZLZkW6o.xjG\">busy</variable><variable id=\"K|m6:+N*Gdf$t?.Oo.h9\">cmd</variable><variable id=\"sjlWtli-~$D-U/8.%W:O\">raw</variable><variable id=\"Zv;oxq_ZE#h-Qcd^R;1%\">cmd2</variable><variable id=\"Tsqyouk@?d=*S}]~{(0P\">QDEPTH</variable><variable id=\"Y/@Up(UWfO4NX[2bq~0:\">g</variable></variables><comment x=\"748.2421875\" y=\"4481.5\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (TypeScript) =====\nCommands from app (newline-terminated): :SEQ,OP,ARGS*\\n\nSEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n\nARGS:\nMV,left,right         -&gt; motors(left,right) -100..100 (negatives reverse)\nSP,00                 -&gt; stop\nTL,00 / TR,00         -&gt; turn left/right (instant)\nBK,ss                 -&gt; backward via motors(-ss,-ss); default 50\nHL,01|00              -&gt; headlights on/off (white)\nHL,RR,GG,BB           -&gt; headlights to RGB color (0..FF each)\nBZ,HH,LL,DD           -&gt; buzzer freq=(HH&lt;&lt;8)|LL Hz, dur=DD*10ms (DD=0-&gt;100ms)\nEC,00                 -&gt; echo/no-op\n\nReplies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\nTelemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n</comment><comment x=\"1273.2421875\" y=\"4481.5\" w=\"330\" h=\"120\">\n---------- UI feedback ----------\n</comment><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: Cmd[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"type Cmd = { s: number, o: string, a: number, b: number, c: number }\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"Tsqyouk@?d=*S}]~{(0P\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: Cmd) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: Cmd, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;: {\" line3=\"            const L = clamp(cmd.a, -100, 100)\" line4=\"            const R = clamp(cmd.b, -100, 100)\" line5=\"            cuteBot.motors(L, R)\" line6=\"            break\" line7=\"        }\" line8=\"        case &quot;SP&quot;:\" line9=\"            cuteBot.stopcar()\" line10=\"            break\" line11=\"        case &quot;TL&quot;:\" line12=\"            cuteBot.turnleft()\" line13=\"            break\" line14=\"        case &quot;TR&quot;:\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"        case &quot;BK&quot;: {\" line18=\"            const spd = cmd.a &gt; 0 ? clamp(cmd.a, 0, 100) : 50\" line19=\"            cuteBot.motors(-spd, -spd)\" line20=\"            break\" line21=\"        }\" line22=\"        case &quot;HL&quot;: {\" line23=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line24=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line25=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line26=\"                const rr = hex2((color &gt;&gt; 16) &amp; 0xFF)\" line27=\"                const gg = hex2((color &gt;&gt; 8) &amp; 0xFF)\" line28=\"                const bb = hex2(color &amp; 0xFF)\" line29=\"                send(&quot;#LED,&quot; + rr + gg + bb + &quot;\\n&quot;)\" line30=\"            } else {\" line31=\"                const on = (cmd.a &amp; 0xFF) != 0\" line32=\"                const color2 = on ? 0xFFFFFF : 0x000000\" line33=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color2)\" line34=\"                const rr2 = hex2((color2 &gt;&gt; 16) &amp; 0xFF)\" line35=\"                const gg2 = hex2((color2 &gt;&gt; 8) &amp; 0xFF)\" line36=\"                const bb2 = hex2(color2 &amp; 0xFF)\" line37=\"                send(&quot;#LED,&quot; + rr2 + gg2 + bb2 + &quot;\\n&quot;)\" line38=\"            }\" line39=\"            break\" line40=\"        }\" line41=\"        case &quot;BZ&quot;: {\" line42=\"            const freq = clamp(((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF), 100, 5000)\" line43=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line44=\"            if (dur &lt;= 0) dur = 100\" line45=\"            music.playTone(freq, dur)\" line46=\"            control.inBackground(() =&gt; {\" line47=\"                basic.pause(dur)\" line48=\"                send(&quot;#BUZ,done\\n&quot;)\" line49=\"            })\" line50=\"            break\" line51=\"        }\" line52=\"        case &quot;EC&quot;:\" line53=\"            break\" line54=\"        default:\" line55=\"            sendErr(cmd.s, 0x01)\" line56=\"            done()\" line57=\"            return\" line58=\"    }\" line59=\"\" line60=\"    control.inBackground(() =&gt; {\" line61=\"        basic.pause(10)\" line62=\"        sendAck(cmd.s)\" line63=\"        done()\" line64=\"    })\" line65=\"}\" numlines=\"66\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"990\" y=\"20\"><field name=\"VALUE\">s</field></block><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"1083\" y=\"20\"><field name=\"VALUE\">raw</field></block><block type=\"bluetooth_on_connected\" x=\"1181\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"Oa+yVNw89a[OSvNroCvG\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"1599\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"sjlWtli-~$D-U/8.%W:O\">raw</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"Zv;oxq_ZE#h-Qcd^R;1%\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"OvYC-Nc*Og,QA.MI15V)\"><arg name=\"raw\" id=\"cswio61bumfyxbdyofd67\" type=\"string\"></arg></mutation><value name=\"cswio61bumfyxbdyofd67\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"sjlWtli-~$D-U/8.%W:O\">raw</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"Zv;oxq_ZE#h-Qcd^R;1%\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendErr\" functionid=\",`vGfQnJb$Fb~?3O6IU}\"><arg name=\"seq\" id=\"kjeubcyajba6voq5z7n1c\" type=\"number\"></arg><arg name=\"ec\" id=\"47rnb7xghvhgnhssg3k1s\" type=\"number\"></arg></mutation><value name=\"kjeubcyajba6voq5z7n1c\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value><value name=\"47rnb7xghvhgnhssg3k1s\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5r{RE!~MTZLZkW6o.xjG\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"T9{?QLa{9,CmNg(D4~$M\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"Tsqyouk@?d=*S}]~{(0P\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"5F6+Dpm%ASON-}zk`)D(\"><arg name=\"seq\" id=\"24hlk9cj6kz53wi5o2midy\" type=\"number\"></arg></mutation><value name=\"24hlk9cj6kz53wi5o2midy\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"5F6+Dpm%ASON-}zk`)D(\"><arg name=\"seq\" id=\"24hlk9cj6kz53wi5o2midy\" type=\"number\"></arg></mutation><value name=\"24hlk9cj6kz53wi5o2midy\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"%YbVz}Ubuz}u%#Th4-HT\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_disconnected\" x=\"2398\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"Oa+yVNw89a[OSvNroCvG\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"device_clear_display\"><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></next></block></next></block></statement></block><block type=\"device_button_event\" x=\"2825\" y=\"20\"><field name=\"NAME\">Button.A</field><comment pinned=\"false\" h=\"80\" w=\"160\">--- Button A: show card name quickly ---</comment><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"basic.showString(control.deviceName(), 50)\" numlines=\"1\"></mutation><next><block type=\"controls_if\"><mutation else=\"1\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">restore icon based on BLE state</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"Oa+yVNw89a[OSvNroCvG\">bleConnected</field></block></value><statement name=\"DO0\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></statement><statement name=\"ELSE\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></statement></block></next></block></statement></block><block type=\"every_interval\" x=\"3306\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry loop ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"Y/@Up(UWfO4NX[2bq~0:\">g</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"Y/@Up(UWfO4NX[2bq~0:\">g</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4008\" y=\"20\"><mutation name=\"clamp\" functionid=\"*Pv@(jcjX`,hZ)F`Z_f,\"><arg name=\"v\" id=\"puilbdzkwudv9umkvtjxl\" type=\"number\"></arg><arg name=\"lo\" id=\"293qnr6kf2oy39j8d8el\" type=\"number\"></arg><arg name=\"hi\" id=\"j26fmkvpjc1ekh8z4i5l\" type=\"number\"></arg></mutation><field name=\"function_name\">clamp</field><value name=\"puilbdzkwudv9umkvtjxl\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">v</field></block></value><value name=\"293qnr6kf2oy39j8d8el\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">lo</field></block></value><value name=\"j26fmkvpjc1ekh8z4i5l\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">hi</field></block></value><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"math_op2\"><field name=\"op\">max</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">lo</field></block></value><value name=\"y\"><block type=\"math_op2\"><field name=\"op\">min</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">hi</field></block></value><value name=\"y\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">v</field></block></value></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"3292\"><mutation name=\"hex2\" functionid=\"xHW93nPC?pr]]E_P{c?s\"><arg name=\"n\" id=\"kagqjkxwsfk8dw91il19\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"kagqjkxwsfk8dw91il19\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"]|Cw$0MdsXhIn7s[H5N7\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"]|Cw$0MdsXhIn7s[H5N7\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"]|Cw$0MdsXhIn7s[H5N7\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"981\" y=\"3292\"><mutation name=\"parseHexByte\" functionid=\"qLyxs2I]QjA]qh.6SvoF\"><arg name=\"s\" id=\"kh93wt5sf0kbo7f0jau3a\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"kh93wt5sf0kbo7f0jau3a\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"wX8/pXHxT+GACX4a(kqv\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"1509\" y=\"3292\"><mutation name=\"send\" functionid=\"P6O5i/U{q#4:rwg+I=6=\"><arg name=\"line\" id=\"17r1i8f1ekve8n4mw10ye\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"17r1i8f1ekve8n4mw10ye\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"1914\" y=\"3292\"><mutation name=\"sendAck\" functionid=\"+cy)Ij7Eq1jawAxB;ctm\"><arg name=\"seq\" id=\"7hpf9olkyr7dbsdc9g67l\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"7hpf9olkyr7dbsdc9g67l\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"P6O5i/U{q#4:rwg+I=6=\"><arg name=\"line\" id=\"17r1i8f1ekve8n4mw10ye\" type=\"string\"></arg></mutation><value name=\"17r1i8f1ekve8n4mw10ye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"xHW93nPC?pr]]E_P{c?s\"><arg name=\"n\" id=\"kagqjkxwsfk8dw91il19\" type=\"number\"></arg></mutation><value name=\"kagqjkxwsfk8dw91il19\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2547\" y=\"3292\"><mutation name=\"sendBusy\" functionid=\"5F6+Dpm%ASON-}zk`)D(\"><arg name=\"seq\" id=\"24hlk9cj6kz53wi5o2midy\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"24hlk9cj6kz53wi5o2midy\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"P6O5i/U{q#4:rwg+I=6=\"><arg name=\"line\" id=\"17r1i8f1ekve8n4mw10ye\" type=\"string\"></arg></mutation><value name=\"17r1i8f1ekve8n4mw10ye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"xHW93nPC?pr]]E_P{c?s\"><arg name=\"n\" id=\"kagqjkxwsfk8dw91il19\" type=\"number\"></arg></mutation><value name=\"kagqjkxwsfk8dw91il19\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3189\" y=\"3292\"><mutation name=\"sendErr\" functionid=\",`vGfQnJb$Fb~?3O6IU}\"><arg name=\"seq\" id=\"kjeubcyajba6voq5z7n1c\" type=\"number\"></arg><arg name=\"ec\" id=\"47rnb7xghvhgnhssg3k1s\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"kjeubcyajba6voq5z7n1c\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"47rnb7xghvhgnhssg3k1s\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"P6O5i/U{q#4:rwg+I=6=\"><arg name=\"line\" id=\"17r1i8f1ekve8n4mw10ye\" type=\"string\"></arg></mutation><value name=\"17r1i8f1ekve8n4mw10ye\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"xHW93nPC?pr]]E_P{c?s\"><arg name=\"n\" id=\"kagqjkxwsfk8dw91il19\" type=\"number\"></arg></mutation><value name=\"kagqjkxwsfk8dw91il19\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"xHW93nPC?pr]]E_P{c?s\"><arg name=\"n\" id=\"kagqjkxwsfk8dw91il19\" type=\"number\"></arg></mutation><value name=\"kagqjkxwsfk8dw91il19\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3578\" y=\"3292\"><mutation name=\"qPop\" functionid=\"eU/0P[Ugx7S!-`?GFNw;\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"T9{?QLa{9,CmNg(D4~$M\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"T9{?QLa{9,CmNg(D4~$M\">q</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4128\" y=\"3292\"><mutation name=\"parseLine\" functionid=\"OvYC-Nc*Og,QA.MI15V)\"><arg name=\"raw\" id=\"cswio61bumfyxbdyofd67\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser ----------</comment><value name=\"cswio61bumfyxbdyofd67\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">raw</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const line = raw.split(&quot;\\r&quot;).join(&quot;&quot;).trim()\" numlines=\"1\" declaredvars=\"line\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"kZB@9Hz?-{r#)aRh$Dmn\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"kZB@9Hz?-{r#)aRh$Dmn\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"NsNo8[tXuux-`D|Ebio?\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"]yC2p.432V5M?4VcN?Yy\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"NsNo8[tXuux-`D|Ebio?\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const op = (parts[1] || &quot;&quot;).toUpperCase()\" numlines=\"1\" declaredvars=\"op\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"4482\"><mutation name=\"pump\" functionid=\"%YbVz}Ubuz}u%#Th4-HT\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5r{RE!~MTZLZkW6o.xjG\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"T9{?QLa{9,CmNg(D4~$M\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"5r{RE!~MTZLZkW6o.xjG\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"K|m6:+N*Gdf$t?.Oo.h9\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"eU/0P[Ugx7S!-`?GFNw;\"></mutation></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"K|m6:+N*Gdf$t?.Oo.h9\">cmd</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\"><field name=\"VAR\" id=\"5r{RE!~MTZLZkW6o.xjG\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></next></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (TypeScript) =====\n// Commands from app (newline-terminated): :SEQ,OP,ARGS*\\n\n// SEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n//\n// ARGS:\n//   MV,left,right         -> motors(left,right) -100..100 (negatives reverse)\n//   SP,00                 -> stop\n//   TL,00 / TR,00         -> turn left/right (instant)\n//   BK,ss                 -> backward via motors(-ss,-ss); default 50\n//   HL,01|00              -> headlights on/off (white)\n//   HL,RR,GG,BB           -> headlights to RGB color (0..FF each)\n//   BZ,HH,LL,DD           -> buzzer freq=(HH<<8)|LL Hz, dur=DD*10ms (DD=0->100ms)\n//   EC,00                 -> echo/no-op\n//\n// Replies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n// Telemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n\nbluetooth.startUartService()\n\n// ---------- UI feedback ----------\nlet bleConnected = false\n\nbluetooth.onBluetoothConnected(function () {\n    bleConnected = true\n    basic.showIcon(IconNames.Heart)\n})\n\nbluetooth.onBluetoothDisconnected(function () {\n    bleConnected = false\n    basic.clearScreen()\n    basic.showIcon(IconNames.SmallDiamond)\n})\n\n// --- Button A: show card name quickly ---\ninput.onButtonPressed(Button.A, function () {\n    // display BLE device name quickly\n    basic.showString(control.deviceName(), 50)\n    // restore icon based on BLE state\n    if (bleConnected) basic.showIcon(IconNames.Heart)\n    else basic.showIcon(IconNames.SmallDiamond)\n})\n\n// ---------- types ----------\ntype Cmd = { s: number, o: string, a: number, b: number, c: number }\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\n\nfunction parseHexByte(s: string) {\n    if (!s) return 0\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48\n        else if (c >= 65 && c <= 70) d = c - 55\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\n\nfunction clamp(v: number, lo: number, hi: number) {\n    return Math.max(lo, Math.min(hi, v))\n}\n\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(seq: number) { send(\":\" + hex2(seq) + \",ACK\\n\") }\nfunction sendBusy(seq: number) { send(\":\" + hex2(seq) + \",BUSY\\n\") }\nfunction sendErr(seq: number, ec: number) { send(\":\" + hex2(seq) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue ----------\nconst QDEPTH = 6\nconst q: Cmd[] = []\nlet busy = false\n\nfunction qPush(c: Cmd) {\n    if (q.length >= QDEPTH) return false\n    q.push(c)\n    return true\n}\nfunction qPop(): Cmd | null {\n    if (q.length == 0) return null\n    return q.shift()\n}\n\n// ---------- parser ----------\nfunction parseLine(raw: string): Cmd | null {\n    if (!raw) return null\n    // MakeCode-safe: String.replace doesn't take RegExp; use split/join\n    const line = raw.split(\"\\r\").join(\"\").trim()\n    if (line.length < 5) return null\n    if (line.charAt(0) != \":\") return null\n\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return null\n\n    const seq = parseInt(parts[0], 16)\n    const op = (parts[1] || \"\").toUpperCase()\n    const a = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    const b = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    const c = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    return { s: isNaN(seq) ? 0 : (seq & 0xFF), o: op, a: a, b: b, c: c }\n}\n\n// ---------- executor ----------\nfunction runOne(cmd: Cmd, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\": {\n            const L = clamp(cmd.a, -100, 100)\n            const R = clamp(cmd.b, -100, 100)\n            cuteBot.motors(L, R)\n            break\n        }\n        case \"SP\":\n            cuteBot.stopcar()\n            break\n        case \"TL\":\n            cuteBot.turnleft()\n            break\n        case \"TR\":\n            cuteBot.turnright()\n            break\n        case \"BK\": {\n            const spd = cmd.a > 0 ? clamp(cmd.a, 0, 100) : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n        case \"HL\": {\n            if (cmd.b > 0 || cmd.c > 0) {\n                const color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            } else {\n                const on = (cmd.a & 0xFF) != 0\n                const color = on ? 0xFFFFFF : 0x000000\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            }\n            break\n        }\n        case \"BZ\": {\n            const freq = clamp(((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF), 100, 5000)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            music.playTone(freq, dur)\n            control.inBackground(() => {\n                basic.pause(dur)\n                send(\"#BUZ,done\\n\")\n            })\n            break\n        }\n        case \"EC\":\n            break\n        default:\n            sendErr(cmd.s, 0x01)\n            done()\n            return\n    }\n\n    control.inBackground(() => {\n        basic.pause(10)\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd: Cmd | null = qPop()\n    if (!cmd) { busy = false; return }\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const raw = bluetooth.uartReadUntil(\"\\n\")\n    const cmd: Cmd | null = parseLine(raw)\n    if (!cmd) {\n        sendErr(0x00, 0x02)\n        return\n    }\n    if (busy && q.length >= QDEPTH) { sendBusy(cmd.s); return }\n    if (!qPush(cmd)) { sendBusy(cmd.s); return }\n    pump()\n})\n\n// ---------- telemetry loop ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1761146233204,"editorVersion":"8.0.17","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</variable><variable id=\"](5e[stlsG_ssIAIIhM0\">d</variable><variable id=\"IdeJ/P^a#Vn2X[rLgd5M\">t</variable><variable id=\"#;yrbqUAUD?PB{|*1Y[i\">q</variable><variable id=\"DvFb~QP;Lm(;?C3;q~%#\">line</variable><variable id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</variable><variable id=\"4)m-TU+K.AtkG_1KNIeR\">core</variable><variable id=\"{W9.v0).NR68_,Qm/To=\">busy</variable><variable id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</variable><variable id=\"k.hm9|Z#os50|-5W%kHq\">raw</variable><variable id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</variable><variable id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</variable><variable id=\"vadM6WUIUEojn!e#!Bip\">g</variable></variables><comment x=\"748\" y=\"4481\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (TypeScript) =====\nCommands from app (newline-terminated): :SEQ,OP,ARGS*\\n\nSEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n\nARGS:\nMV,left,right         -&gt; motors(left,right) -100..100 (negatives reverse)\nSP,00                 -&gt; stop\nTL,00 / TR,00         -&gt; turn left/right (instant)\nBK,ss                 -&gt; backward via motors(-ss,-ss); default 50\nHL,01|00              -&gt; headlights on/off (white)\nHL,RR,GG,BB           -&gt; headlights to RGB color (0..FF each)\nBZ,HH,LL,DD           -&gt; buzzer freq=(HH&lt;&lt;8)|LL Hz, dur=DD*10ms (DD=0-&gt;100ms)\nEC,00                 -&gt; echo/no-op\n\nReplies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\nTelemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n</comment><comment x=\"1273\" y=\"4481\" w=\"330\" h=\"120\">\n---------- UI feedback ----------\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">s</field></block><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">raw</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: Cmd[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"type Cmd = { s: number, o: string, a: number, b: number, c: number }\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: Cmd) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: Cmd, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;: {\" line3=\"            const L = clamp(cmd.a, -100, 100)\" line4=\"            const R = clamp(cmd.b, -100, 100)\" line5=\"            cuteBot.motors(L, R)\" line6=\"            break\" line7=\"        }\" line8=\"        case &quot;SP&quot;:\" line9=\"            cuteBot.stopcar()\" line10=\"            break\" line11=\"        case &quot;TL&quot;:\" line12=\"            cuteBot.turnleft()\" line13=\"            break\" line14=\"        case &quot;TR&quot;:\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"        case &quot;BK&quot;: {\" line18=\"            const spd = cmd.a &gt; 0 ? clamp(cmd.a, 0, 100) : 50\" line19=\"            cuteBot.motors(-spd, -spd)\" line20=\"            break\" line21=\"        }\" line22=\"        case &quot;HL&quot;: {\" line23=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line24=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line25=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line26=\"                const rr = hex2((color &gt;&gt; 16) &amp; 0xFF)\" line27=\"                const gg = hex2((color &gt;&gt; 8) &amp; 0xFF)\" line28=\"                const bb = hex2(color &amp; 0xFF)\" line29=\"                send(&quot;#LED,&quot; + rr + gg + bb + &quot;\\n&quot;)\" line30=\"            } else {\" line31=\"                const on = (cmd.a &amp; 0xFF) != 0\" line32=\"                const color2 = on ? 0xFFFFFF : 0x000000\" line33=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color2)\" line34=\"                const rr2 = hex2((color2 &gt;&gt; 16) &amp; 0xFF)\" line35=\"                const gg2 = hex2((color2 &gt;&gt; 8) &amp; 0xFF)\" line36=\"                const bb2 = hex2(color2 &amp; 0xFF)\" line37=\"                send(&quot;#LED,&quot; + rr2 + gg2 + bb2 + &quot;\\n&quot;)\" line38=\"            }\" line39=\"            break\" line40=\"        }\" line41=\"        case &quot;BZ&quot;: {\" line42=\"            const freq = clamp(((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF), 100, 5000)\" line43=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line44=\"            if (dur &lt;= 0) dur = 100\" line45=\"            music.playTone(freq, dur)\" line46=\"            control.inBackground(() =&gt; {\" line47=\"                basic.pause(dur)\" line48=\"                send(&quot;#BUZ,done\\n&quot;)\" line49=\"            })\" line50=\"            break\" line51=\"        }\" line52=\"        case &quot;EC&quot;:\" line53=\"            break\" line54=\"        default:\" line55=\"            sendErr(cmd.s, 0x01)\" line56=\"            done()\" line57=\"            return\" line58=\"    }\" line59=\"\" line60=\"    control.inBackground(() =&gt; {\" line61=\"        basic.pause(10)\" line62=\"        sendAck(cmd.s)\" line63=\"        done()\" line64=\"    })\" line65=\"}\" numlines=\"66\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_connected\" x=\"1181\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"1599\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"k.hm9|Z#os50|-5W%kHq\">raw</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"pm`W2S*=EoYIu+Z.!~f2\"><arg name=\"raw\" id=\"uz0mku3fk8gzj4hhr0v\" type=\"string\"></arg></mutation><value name=\"uz0mku3fk8gzj4hhr0v\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"k.hm9|Z#os50|-5W%kHq\">raw</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendErr\" functionid=\"?h[1fy@t{kLfv!2P%elT\"><arg name=\"seq\" id=\"7ome0ocag18rbht7ut0jh\" type=\"number\"></arg><arg name=\"ec\" id=\"hn32k7nkug5m0eio9zux\" type=\"number\"></arg></mutation><value name=\"7ome0ocag18rbht7ut0jh\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value><value name=\"hn32k7nkug5m0eio9zux\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><value name=\"s56py5ztn5p0vdx64m7l\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><value name=\"s56py5ztn5p0vdx64m7l\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"c#Wg.,4A,#Eshh:z#Gbq\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_disconnected\" x=\"2398\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"device_clear_display\"><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></next></block></next></block></statement></block><block type=\"device_button_event\" x=\"2825\" y=\"20\"><field name=\"NAME\">Button.A</field><comment pinned=\"false\" h=\"80\" w=\"160\">--- Button A: show card name quickly ---</comment><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"basic.showString(control.deviceName(), 50)\" numlines=\"1\"></mutation><next><block type=\"controls_if\"><mutation else=\"1\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">restore icon based on BLE state</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field></block></value><statement name=\"DO0\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></statement><statement name=\"ELSE\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></statement></block></next></block></statement></block><block type=\"every_interval\" x=\"3306\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry loop ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"vadM6WUIUEojn!e#!Bip\">g</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"vadM6WUIUEojn!e#!Bip\">g</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4008\" y=\"20\"><mutation name=\"clamp\" functionid=\"Jep9@0^At#P7ldJ_!Y@v\"><arg name=\"v\" id=\"5xez5ne62n9park8h2v11\" type=\"number\"></arg><arg name=\"lo\" id=\"gapumokl7eapn2h1efp0o\" type=\"number\"></arg><arg name=\"hi\" id=\"gecefb66x1wdoar1a2nv\" type=\"number\"></arg></mutation><field name=\"function_name\">clamp</field><value name=\"5xez5ne62n9park8h2v11\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">v</field></block></value><value name=\"gapumokl7eapn2h1efp0o\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">lo</field></block></value><value name=\"gecefb66x1wdoar1a2nv\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">hi</field></block></value><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"math_op2\"><field name=\"op\">max</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">lo</field></block></value><value name=\"y\"><block type=\"math_op2\"><field name=\"op\">min</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">hi</field></block></value><value name=\"y\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">v</field></block></value></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"3292\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"apjmq4fa9kiyk5mwazgis\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"981\" y=\"3292\"><mutation name=\"parseHexByte\" functionid=\"(7^gB|RQNFpRk_$36~:a\"><arg name=\"s\" id=\"4f2rlrtsm19srbd0pcvi\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"4f2rlrtsm19srbd0pcvi\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"IdeJ/P^a#Vn2X[rLgd5M\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"1509\" y=\"3292\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"tyx7r1qtiggzv6h3wf3q\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"1914\" y=\"3292\"><mutation name=\"sendAck\" functionid=\"x)Hj)f)f/c8`|l9w#xw4\"><arg name=\"seq\" id=\"2vcb4j5x6slht99wsw814\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"2vcb4j5x6slht99wsw814\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2547\" y=\"3292\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"s56py5ztn5p0vdx64m7l\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3189\" y=\"3292\"><mutation name=\"sendErr\" functionid=\"?h[1fy@t{kLfv!2P%elT\"><arg name=\"seq\" id=\"7ome0ocag18rbht7ut0jh\" type=\"number\"></arg><arg name=\"ec\" id=\"hn32k7nkug5m0eio9zux\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"7ome0ocag18rbht7ut0jh\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"hn32k7nkug5m0eio9zux\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3578\" y=\"3292\"><mutation name=\"qPop\" functionid=\"rt@H:(Wvo+VNR,}M6i.D\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4128\" y=\"3292\"><mutation name=\"parseLine\" functionid=\"pm`W2S*=EoYIu+Z.!~f2\"><arg name=\"raw\" id=\"uz0mku3fk8gzj4hhr0v\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser ----------</comment><value name=\"uz0mku3fk8gzj4hhr0v\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">raw</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const line = raw.split(&quot;\\r&quot;).join(&quot;&quot;).trim()\" numlines=\"1\" declaredvars=\"line\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"DvFb~QP;Lm(;?C3;q~%#\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DvFb~QP;Lm(;?C3;q~%#\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"4)m-TU+K.AtkG_1KNIeR\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const op = (parts[1] || &quot;&quot;).toUpperCase()\" numlines=\"1\" declaredvars=\"op\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"4482\"><mutation name=\"pump\" functionid=\"c#Wg.,4A,#Eshh:z#Gbq\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"rt@H:(Wvo+VNR,}M6i.D\"></mutation></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></next></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (TypeScript) =====\n// Commands from app (newline-terminated): :SEQ,OP,ARGS*\\n\n// SEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n//\n// ARGS:\n//   MV,left,right         -> motors(left,right) -100..100 (negatives reverse)\n//   SP,00                 -> stop\n//   TL,00 / TR,00         -> turn left/right (instant)\n//   BK,ss                 -> backward via motors(-ss,-ss); default 50\n//   HL,01|00              -> headlights on/off (white)\n//   HL,RR,GG,BB           -> headlights to RGB color (0..FF each)\n//   BZ,HH,LL,DD           -> buzzer freq=(HH<<8)|LL Hz, dur=DD*10ms (DD=0->100ms)\n//   EC,00                 -> echo/no-op\n//\n// Replies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n// Telemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n\nbluetooth.startUartService()\n\n// ---------- UI feedback ----------\nlet bleConnected = false\n\nbluetooth.onBluetoothConnected(function () {\n    bleConnected = true\n    basic.showIcon(IconNames.Heart)\n})\n\nbluetooth.onBluetoothDisconnected(function () {\n    bleConnected = false\n    basic.clearScreen()\n    basic.showIcon(IconNames.SmallDiamond)\n})\n\n// --- Button A: show card name quickly ---\ninput.onButtonPressed(Button.A, function () {\n    // display BLE device name quickly\n    basic.showString(control.deviceName(), 50)\n    // restore icon based on BLE state\n    if (bleConnected) basic.showIcon(IconNames.Heart)\n    else basic.showIcon(IconNames.SmallDiamond)\n})\n\n// ---------- types ----------\ntype Cmd = { s: number, o: string, a: number, b: number, c: number }\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\n\nfunction parseHexByte(s: string) {\n    if (!s) return 0\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48\n        else if (c >= 65 && c <= 70) d = c - 55\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\n\nfunction clamp(v: number, lo: number, hi: number) {\n    return Math.max(lo, Math.min(hi, v))\n}\n\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(seq: number) { send(\":\" + hex2(seq) + \",ACK\\n\") }\nfunction sendBusy(seq: number) { send(\":\" + hex2(seq) + \",BUSY\\n\") }\nfunction sendErr(seq: number, ec: number) { send(\":\" + hex2(seq) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue ----------\nconst QDEPTH = 6\nconst q: Cmd[] = []\nlet busy = false\n\nfunction qPush(c: Cmd) {\n    if (q.length >= QDEPTH) return false\n    q.push(c)\n    return true\n}\nfunction qPop(): Cmd | null {\n    if (q.length == 0) return null\n    return q.shift()\n}\n\n// ---------- parser ----------\nfunction parseLine(raw: string): Cmd | null {\n    if (!raw) return null\n    // MakeCode-safe: String.replace doesn't take RegExp; use split/join\n    const line = raw.split(\"\\r\").join(\"\").trim()\n    if (line.length < 5) return null\n    if (line.charAt(0) != \":\") return null\n\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return null\n\n    const seq = parseInt(parts[0], 16)\n    const op = (parts[1] || \"\").toUpperCase()\n    const a = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    const b = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    const c = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    return { s: isNaN(seq) ? 0 : (seq & 0xFF), o: op, a: a, b: b, c: c }\n}\n\n// ---------- executor ----------\nfunction runOne(cmd: Cmd, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\": {\n            const L = clamp(cmd.a, -100, 100)\n            const R = clamp(cmd.b, -100, 100)\n            cuteBot.motors(L, R)\n            break\n        }\n        case \"SP\":\n            cuteBot.stopcar()\n            break\n        case \"TL\":\n            cuteBot.turnleft()\n            break\n        case \"TR\":\n            cuteBot.turnright()\n            break\n        case \"BK\": {\n            const spd = cmd.a > 0 ? clamp(cmd.a, 0, 100) : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n        case \"HL\": {\n            if (cmd.b > 0 || cmd.c > 0) {\n                const color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            } else {\n                const on = (cmd.a & 0xFF) != 0\n                const color = on ? 0xFFFFFF : 0x000000\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            }\n            break\n        }\n        case \"BZ\": {\n            const freq = clamp(((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF), 100, 5000)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            music.playTone(freq, dur)\n            control.inBackground(() => {\n                basic.pause(dur)\n                send(\"#BUZ,done\\n\")\n            })\n            break\n        }\n        case \"EC\":\n            break\n        default:\n            sendErr(cmd.s, 0x01)\n            done()\n            return\n    }\n\n    control.inBackground(() => {\n        basic.pause(10)\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd: Cmd | null = qPop()\n    if (!cmd) { busy = false; return }\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const raw = bluetooth.uartReadUntil(\"\\n\")\n    const cmd: Cmd | null = parseLine(raw)\n    if (!cmd) {\n        sendErr(0x00, 0x02)\n        return\n    }\n    if (busy && q.length >= QDEPTH) { sendBusy(cmd.s); return }\n    if (!qPush(cmd)) { sendBusy(cmd.s); return }\n    pump()\n})\n\n// ---------- telemetry loop ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\"\n}\n"}},{"timestamp":1761155672095,"editorVersion":"8.0.17","text":{"main.blocks":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><variables><variable id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</variable><variable id=\"](5e[stlsG_ssIAIIhM0\">d</variable><variable id=\"IdeJ/P^a#Vn2X[rLgd5M\">t</variable><variable id=\"#;yrbqUAUD?PB{|*1Y[i\">q</variable><variable id=\"DvFb~QP;Lm(;?C3;q~%#\">line</variable><variable id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</variable><variable id=\"4)m-TU+K.AtkG_1KNIeR\">core</variable><variable id=\"{W9.v0).NR68_,Qm/To=\">busy</variable><variable id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</variable><variable id=\"k.hm9|Z#os50|-5W%kHq\">raw</variable><variable id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</variable><variable id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</variable><variable id=\"vadM6WUIUEojn!e#!Bip\">g</variable></variables><comment x=\"748\" y=\"4481\" w=\"480\" h=\"360\">\n===== Cutebot + BLE UART Command Processor (TypeScript) =====\nCommands from app (newline-terminated): :SEQ,OP,ARGS*\\n\nSEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n\nARGS:\nMV,left,right         -&gt; motors(left,right) -100..100 (negatives reverse)\nSP,00                 -&gt; stop\nTL,00 / TR,00         -&gt; turn left/right (instant)\nBK,ss                 -&gt; backward via motors(-ss,-ss); default 50\nHL,01|00              -&gt; headlights on/off (white)\nHL,RR,GG,BB           -&gt; headlights to RGB color (0..FF each)\nBZ,HH,LL,DD           -&gt; buzzer freq=(HH&lt;&lt;8)|LL Hz, dur=DD*10ms (DD=0-&gt;100ms)\nEC,00                 -&gt; echo/no-op\n\nReplies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\nTelemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n</comment><comment x=\"1273\" y=\"4481\" w=\"330\" h=\"120\">\n---------- UI feedback ----------\n</comment><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">s</field></block><block type=\"argument_reporter_string\" disabled-reasons=\"pxt_automatic_disabled\" x=\"0\" y=\"0\"><field name=\"VALUE\">raw</field></block><block type=\"pxt-on-start\" x=\"20\" y=\"20\"><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let busy = false\" numlines=\"1\" declaredvars=\"busy\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let q: Cmd[] = []\" numlines=\"1\" declaredvars=\"q\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"let v = 0\" numlines=\"1\" declaredvars=\"v\"></mutation><next><block type=\"bluetooth_start_uart_service\"><data>0</data><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"type Cmd = { s: number, o: string, a: number, b: number, c: number }\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- queue ----------</comment><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">6</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function qPush(c: Cmd) {\" line1=\"    if (q.length &gt;= QDEPTH) return false\" line2=\"    q.push(c)\" line3=\"    return true\" line4=\"}\" numlines=\"5\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"function runOne(cmd: Cmd, done: () =&gt; void) {\" line1=\"    switch (cmd.o) {\" line2=\"        case &quot;MV&quot;: {\" line3=\"            const L = clamp(cmd.a, -100, 100)\" line4=\"            const R = clamp(cmd.b, -100, 100)\" line5=\"            cuteBot.motors(L, R)\" line6=\"            break\" line7=\"        }\" line8=\"        case &quot;SP&quot;:\" line9=\"            cuteBot.stopcar()\" line10=\"            break\" line11=\"        case &quot;TL&quot;:\" line12=\"            cuteBot.turnleft()\" line13=\"            break\" line14=\"        case &quot;TR&quot;:\" line15=\"            cuteBot.turnright()\" line16=\"            break\" line17=\"        case &quot;BK&quot;: {\" line18=\"            const spd = cmd.a &gt; 0 ? clamp(cmd.a, 0, 100) : 50\" line19=\"            cuteBot.motors(-spd, -spd)\" line20=\"            break\" line21=\"        }\" line22=\"        case &quot;HL&quot;: {\" line23=\"            if (cmd.b &gt; 0 || cmd.c &gt; 0) {\" line24=\"                const color = ((cmd.a &amp; 0xFF) &lt;&lt; 16) | ((cmd.b &amp; 0xFF) &lt;&lt; 8) | (cmd.c &amp; 0xFF)\" line25=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\" line26=\"                const rr = hex2((color &gt;&gt; 16) &amp; 0xFF)\" line27=\"                const gg = hex2((color &gt;&gt; 8) &amp; 0xFF)\" line28=\"                const bb = hex2(color &amp; 0xFF)\" line29=\"                send(&quot;#LED,&quot; + rr + gg + bb + &quot;\\n&quot;)\" line30=\"            } else {\" line31=\"                const on = (cmd.a &amp; 0xFF) != 0\" line32=\"                const color2 = on ? 0xFFFFFF : 0x000000\" line33=\"                cuteBot.colorLight(cuteBot.RGBLights.ALL, color2)\" line34=\"                const rr2 = hex2((color2 &gt;&gt; 16) &amp; 0xFF)\" line35=\"                const gg2 = hex2((color2 &gt;&gt; 8) &amp; 0xFF)\" line36=\"                const bb2 = hex2(color2 &amp; 0xFF)\" line37=\"                send(&quot;#LED,&quot; + rr2 + gg2 + bb2 + &quot;\\n&quot;)\" line38=\"            }\" line39=\"            break\" line40=\"        }\" line41=\"        case &quot;BZ&quot;: {\" line42=\"            const freq = clamp(((cmd.a &amp; 0xFF) &lt;&lt; 8) | (cmd.b &amp; 0xFF), 100, 5000)\" line43=\"            let dur = (cmd.c &amp; 0xFF) * 10\" line44=\"            if (dur &lt;= 0) dur = 100\" line45=\"            music.playTone(freq, dur)\" line46=\"            control.inBackground(() =&gt; {\" line47=\"                basic.pause(dur)\" line48=\"                send(&quot;#BUZ,done\\n&quot;)\" line49=\"            })\" line50=\"            break\" line51=\"        }\" line52=\"        case &quot;EC&quot;:\" line53=\"            break\" line54=\"        default:\" line55=\"            sendErr(cmd.s, 0x01)\" line56=\"            done()\" line57=\"            return\" line58=\"    }\" line59=\"\" line60=\"    control.inBackground(() =&gt; {\" line61=\"        basic.pause(10)\" line62=\"        sendAck(cmd.s)\" line63=\"        done()\" line64=\"    })\" line65=\"}\" numlines=\"66\"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_connected\" x=\"1181\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></next></block></statement></block><block type=\"bluetooth_on_data_received\" x=\"1599\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- BLE receive ----------</comment><value name=\"delimiters\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"k.hm9|Z#os50|-5W%kHq\">raw</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"bluetooth_uart_read\"><value name=\"del\"><shadow type=\"serial_delimiter_conv\"><field name=\"del\">Delimiters.NewLine</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"parseLine\" functionid=\"pm`W2S*=EoYIu+Z.!~f2\"><arg name=\"raw\" id=\"uz0mku3fk8gzj4hhr0v\" type=\"string\"></arg></mutation><value name=\"uz0mku3fk8gzj4hhr0v\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"k.hm9|Z#os50|-5W%kHq\">raw</field></block></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"PDNl|dc%)wEixUvkY4BO\">cmd2</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendErr\" functionid=\"?h[1fy@t{kLfv!2P%elT\"><arg name=\"seq\" id=\"7ome0ocag18rbht7ut0jh\" type=\"number\"></arg><arg name=\"ec\" id=\"hn32k7nkug5m0eio9zux\" type=\"number\"></arg></mutation><value name=\"7ome0ocag18rbht7ut0jh\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value><value name=\"hn32k7nkug5m0eio9zux\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">AND</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">GTE</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"5`Yi_HT[Ema;fJf)5+aI\">QDEPTH</field></block></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><value name=\"s56py5ztn5p0vdx64m7l\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">qPush(cmd2)</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_call\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><value name=\"s56py5ztn5p0vdx64m7l\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">cmd2.s</field></block></value><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"return\" numlines=\"1\"></mutation></block></next></block></statement><next><block type=\"function_call\"><mutation name=\"pump\" functionid=\"c#Wg.,4A,#Eshh:z#Gbq\"></mutation></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"bluetooth_on_disconnected\" x=\"2398\" y=\"20\"><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"device_clear_display\"><next><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></next></block></next></block></statement></block><block type=\"device_button_event\" x=\"2825\" y=\"20\"><field name=\"NAME\">Button.A</field><comment pinned=\"false\" h=\"80\" w=\"160\">--- Button A: show card name quickly ---</comment><statement name=\"HANDLER\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"basic.showString(control.deviceName(), 50)\" numlines=\"1\"></mutation><next><block type=\"controls_if\"><mutation else=\"1\"></mutation><comment pinned=\"false\" h=\"80\" w=\"160\">restore icon based on BLE state</comment><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"y_I7og=K1+hl}O_4/qb;\">bleConnected</field></block></value><statement name=\"DO0\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.Heart</field></block></statement><statement name=\"ELSE\"><block type=\"basic_show_icon\"><field name=\"i\">IconNames.SmallDiamond</field></block></statement></block></next></block></statement></block><block type=\"every_interval\" x=\"3306\" y=\"20\"><comment pinned=\"false\" h=\"80\" w=\"160\">---------- telemetry loop ----------</comment><value name=\"interval\"><shadow type=\"longTimePicker\"><field name=\"ms\">500</field></shadow></value><statement name=\"HANDLER\"><block type=\"variables_set\"><field name=\"VAR\" id=\"vadM6WUIUEojn!e#!Bip\">g</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"ultrasonic\"><field name=\"unit\">cuteBot.SonarUnit.Centimeters</field></block></value><next><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">#DIST,</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"vadM6WUIUEojn!e#!Bip\">g</field></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4008\" y=\"20\"><mutation name=\"clamp\" functionid=\"Jep9@0^At#P7ldJ_!Y@v\"><arg name=\"v\" id=\"5xez5ne62n9park8h2v11\" type=\"number\"></arg><arg name=\"lo\" id=\"gapumokl7eapn2h1efp0o\" type=\"number\"></arg><arg name=\"hi\" id=\"gecefb66x1wdoar1a2nv\" type=\"number\"></arg></mutation><field name=\"function_name\">clamp</field><value name=\"5xez5ne62n9park8h2v11\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">v</field></block></value><value name=\"gapumokl7eapn2h1efp0o\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">lo</field></block></value><value name=\"gecefb66x1wdoar1a2nv\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">hi</field></block></value><statement name=\"STACK\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"math_op2\"><field name=\"op\">max</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">lo</field></block></value><value name=\"y\"><block type=\"math_op2\"><field name=\"op\">min</field><value name=\"x\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">hi</field></block></value><value name=\"y\"><block type=\"argument_reporter_number\"><field name=\"VALUE\">v</field></block></value></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"3292\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><field name=\"function_name\">hex2</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- helpers ----------</comment><value name=\"apjmq4fa9kiyk5mwazgis\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">n</field></block></value><statement name=\"STACK\"><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"n &amp;= 0xFF\" numlines=\"1\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">0123456789ABCDEF</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_join\"><mutation items=\"2\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">(n &gt;&gt; 4) &amp; 0xF</field></block></value></block></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"](5e[stlsG_ssIAIIhM0\">d</field></block></value><value name=\"pos\"><block type=\"typescript_expression\"><field name=\"EXPRESSION\">n &amp; 0xF</field></block></value></block></value></block></value></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"981\" y=\"3292\"><mutation name=\"parseHexByte\" functionid=\"(7^gB|RQNFpRk_$36~:a\"><arg name=\"s\" id=\"4f2rlrtsm19srbd0pcvi\" type=\"string\"></arg></mutation><field name=\"function_name\">parseHexByte</field><value name=\"4f2rlrtsm19srbd0pcvi\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">s</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const t = s.trim().toUpperCase()\" numlines=\"1\" declaredvars=\"t\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"IdeJ/P^a#Vn2X[rLgd5M\">t</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"for (let i = 0; i &lt; t.length &amp;&amp; i &lt; 2; i++) {\" line1=\"        const c = t.charCodeAt(i)\" line2=\"        let e = -1\" line3=\"        if (c &gt;= 48 &amp;&amp; c &lt;= 57) e = c - 48\" line4=\"        else if (c &gt;= 65 &amp;&amp; c &lt;= 70) e = c - 55\" line5=\"        if (e &lt; 0) break\" line6=\"        v = (v &lt;&lt; 4) | e\" line7=\"    }\" numlines=\"8\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">v &amp; 0xFF</field></block></value></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"1509\" y=\"3292\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><field name=\"function_name\">send</field><value name=\"tyx7r1qtiggzv6h3wf3q\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">line</field></block></value><statement name=\"STACK\"><block type=\"bluetooth_uart_write\"><value name=\"data\"><block type=\"argument_reporter_string\"><field name=\"VALUE\">line</field></block></value></block></statement></block><block type=\"function_definition\" x=\"1914\" y=\"3292\"><mutation name=\"sendAck\" functionid=\"x)Hj)f)f/c8`|l9w#xw4\"><arg name=\"seq\" id=\"2vcb4j5x6slht99wsw814\" type=\"number\"></arg></mutation><field name=\"function_name\">sendAck</field><value name=\"2vcb4j5x6slht99wsw814\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",ACK\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"2547\" y=\"3292\"><mutation name=\"sendBusy\" functionid=\"#O#^D!uYt)e,:rtf04h~\"><arg name=\"seq\" id=\"s56py5ztn5p0vdx64m7l\" type=\"number\"></arg></mutation><field name=\"function_name\">sendBusy</field><value name=\"s56py5ztn5p0vdx64m7l\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\"><mutation items=\"3\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\",BUSY\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3189\" y=\"3292\"><mutation name=\"sendErr\" functionid=\"?h[1fy@t{kLfv!2P%elT\"><arg name=\"seq\" id=\"7ome0ocag18rbht7ut0jh\" type=\"number\"></arg><arg name=\"ec\" id=\"hn32k7nkug5m0eio9zux\" type=\"number\"></arg></mutation><field name=\"function_name\">sendErr</field><value name=\"7ome0ocag18rbht7ut0jh\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">seq</field></block></value><value name=\"hn32k7nkug5m0eio9zux\"><block type=\"argument_reporter_number\" deletable=\"false\"><field name=\"VALUE\">ec</field></block></value><statement name=\"STACK\"><block type=\"function_call\"><mutation name=\"send\" functionid=\"mJR@9rF@GQqynK).i@-A\"><arg name=\"line\" id=\"tyx7r1qtiggzv6h3wf3q\" type=\"string\"></arg></mutation><value name=\"tyx7r1qtiggzv6h3wf3q\"><shadow type=\"text\"><field name=\"TEXT\">abc</field></shadow><block type=\"text_join\" inline=\"false\"><mutation items=\"5\"></mutation><value name=\"ADD0\"><shadow type=\"text\"><field name=\"TEXT\">:</field></shadow></value><value name=\"ADD1\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">seq</field></block></value></block></value><value name=\"ADD2\"><shadow type=\"text\"><field name=\"TEXT\">,ERR,</field></shadow></value><value name=\"ADD3\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"function_call_output\"><mutation name=\"hex2\" functionid=\"ez4PPkZz*T8t8K)=-g/,\"><arg name=\"n\" id=\"apjmq4fa9kiyk5mwazgis\" type=\"number\"></arg></mutation><value name=\"apjmq4fa9kiyk5mwazgis\"><shadow type=\"math_number\"><field name=\"NUM\">1</field></shadow><block type=\"argument_reporter_number\"><field name=\"VALUE\">ec</field></block></value></block></value><value name=\"ADD4\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">\"\\n\"</field></block></value></block></value></block></statement></block><block type=\"function_definition\" x=\"3578\" y=\"3292\"><mutation name=\"qPop\" functionid=\"rt@H:(Wvo+VNR,}M6i.D\"></mutation><field name=\"function_name\">qPop</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"array_shift\"><value name=\"list\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value></block></next></block></statement></block><block type=\"function_definition\" x=\"4128\" y=\"3292\"><mutation name=\"parseLine\" functionid=\"pm`W2S*=EoYIu+Z.!~f2\"><arg name=\"raw\" id=\"uz0mku3fk8gzj4hhr0v\" type=\"string\"></arg></mutation><field name=\"function_name\">parseLine</field><comment pinned=\"false\" h=\"80\" w=\"160\">---------- parser ----------</comment><value name=\"uz0mku3fk8gzj4hhr0v\"><block type=\"argument_reporter_string\" deletable=\"false\"><field name=\"VALUE\">raw</field></block></value><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const line = raw.split(&quot;\\r&quot;).join(&quot;&quot;).trim()\" numlines=\"1\" declaredvars=\"line\"></mutation><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"DvFb~QP;Lm(;?C3;q~%#\">line</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">5</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">NEQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_get\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"DvFb~QP;Lm(;?C3;q~%#\">line</field></block></value><value name=\"pos\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"text\"><field name=\"TEXT\">:</field></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const core = line.substr(1).trim()\" numlines=\"1\" declaredvars=\"core\"></mutation><next><block type=\"variables_set\"><field name=\"VAR\" id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"string_split\"><value name=\"this\"><shadow type=\"text\"><field name=\"TEXT\"></field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"4)m-TU+K.AtkG_1KNIeR\">core</field></block></value><value name=\"separator\"><shadow type=\"text\"><field name=\"TEXT\">,</field></shadow></value></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">LT</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"a|f[-Y+i.jCH]N(?4ll7\">parts</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">2</field></shadow></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">null</field></block></value></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const seq = parseInt(parts[0], 16)\" numlines=\"1\" declaredvars=\"seq\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const op = (parts[1] || &quot;&quot;).toUpperCase()\" numlines=\"1\" declaredvars=\"op\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const a = parts.length &gt; 2 ? parseHexByte(parts[2]) : 0\" numlines=\"1\" declaredvars=\"a\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const b = parts.length &gt; 3 ? parseHexByte(parts[3]) : 0\" numlines=\"1\" declaredvars=\"b\"></mutation><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"const f = parts.length &gt; 4 ? parseHexByte(parts[4]) : 0\" numlines=\"1\" declaredvars=\"f\"></mutation><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"false\"></mutation><value name=\"RETURN_VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"typescript_expression\"><field name=\"EXPRESSION\">{ s: isNaN(seq) ? 0 : (seq &amp; 0xFF), o: op, a: a, b: b, c: f }</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type=\"function_definition\" x=\"20\" y=\"4482\"><mutation name=\"pump\" functionid=\"c#Wg.,4A,#Eshh:z#Gbq\"></mutation><field name=\"function_name\">pump</field><statement name=\"STACK\"><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_operation\"><field name=\"OP\">OR</field><value name=\"A\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field></block></value><value name=\"B\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_compare\"><field name=\"OP\">EQ</field><value name=\"A\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"lists_length\"><value name=\"VALUE\"><block type=\"variables_get\"><field name=\"VAR\" id=\"#;yrbqUAUD?PB{|*1Y[i\">q</field></block></value></block></value><value name=\"B\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></statement><next><block type=\"variables_set\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></block></value><next><block type=\"variables_set\"><field name=\"VAR\" id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"function_call_output\"><mutation name=\"qPop\" functionid=\"rt@H:(Wvo+VNR,}M6i.D\"></mutation></block></value><next><block type=\"controls_if\"><value name=\"IF0\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"logic_negate\"><value name=\"BOOL\"><shadow type=\"logic_boolean\"><field name=\"BOOL\">TRUE</field></shadow><block type=\"variables_get\"><field name=\"VAR\" id=\"@m@-Ue3OK?=Y6FZOFYRE\">cmd</field></block></value></block></value><statement name=\"DO0\"><block type=\"variables_set\"><field name=\"VAR\" id=\"{W9.v0).NR68_,Qm/To=\">busy</field><value name=\"VALUE\"><shadow type=\"math_number\"><field name=\"NUM\">0</field></shadow><block type=\"logic_boolean\"><field name=\"BOOL\">FALSE</field></block></value><next><block type=\"function_return\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" no_return_value=\"true\"></mutation></block></next></block></statement><next><block type=\"typescript_statement\"><mutation xmlns=\"http://www.w3.org/1999/xhtml\" line0=\"runOne(cmd, () =&gt; { busy = false; pump() })\" numlines=\"1\"></mutation></block></next></block></next></block></next></block></next></block></statement></block></xml>","main.ts":"// ===== Cutebot + BLE UART Command Processor (TypeScript) =====\n// Commands from app (newline-terminated): :SEQ,OP,ARGS*\\n\n// SEQ = 2 hex digits (00..FF), OP = MV|SP|TL|TR|BK|HL|BZ|EC\n//\n// ARGS:\n//   MV,left,right         -> motors(left,right) -100..100 (negatives reverse)\n//   SP,00                 -> stop\n//   TL,00 / TR,00         -> turn left/right (instant)\n//   BK,ss                 -> backward via motors(-ss,-ss); default 50\n//   HL,01|00              -> headlights on/off (white)\n//   HL,RR,GG,BB           -> headlights to RGB color (0..FF each)\n//   BZ,HH,LL,DD           -> buzzer freq=(HH<<8)|LL Hz, dur=DD*10ms (DD=0->100ms)\n//   EC,00                 -> echo/no-op\n//\n// Replies: :SEQ,ACK | :SEQ,BUSY | :SEQ,ERR,EC\n// Telemetry pushes: #DIST,cc (cm), #LED,rrggbb, #BUZ,done\n\nbluetooth.startUartService()\n\n// ---------- UI feedback ----------\nlet bleConnected = false\n\nbluetooth.onBluetoothConnected(function () {\n    bleConnected = true\n    basic.showIcon(IconNames.Heart)\n})\n\nbluetooth.onBluetoothDisconnected(function () {\n    bleConnected = false\n    basic.clearScreen()\n    basic.showIcon(IconNames.SmallDiamond)\n})\n\n// --- Button A: show card name quickly ---\ninput.onButtonPressed(Button.A, function () {\n    // display BLE device name quickly\n    basic.showString(control.deviceName(), 50)\n    // restore icon based on BLE state\n    if (bleConnected) basic.showIcon(IconNames.Heart)\n    else basic.showIcon(IconNames.SmallDiamond)\n})\n\n// ---------- types ----------\ntype Cmd = { s: number, o: string, a: number, b: number, c: number }\n\n// ---------- helpers ----------\nfunction hex2(n: number) {\n    n &= 0xFF\n    const d = \"0123456789ABCDEF\"\n    return d.charAt((n >> 4) & 0xF) + d.charAt(n & 0xF)\n}\n\nfunction parseHexByte(s: string) {\n    if (!s) return 0\n    const t = s.trim().toUpperCase()\n    if (t.length == 0) return 0\n    let v = 0\n    for (let i = 0; i < t.length && i < 2; i++) {\n        const c = t.charCodeAt(i)\n        let d = -1\n        if (c >= 48 && c <= 57) d = c - 48\n        else if (c >= 65 && c <= 70) d = c - 55\n        if (d < 0) break\n        v = (v << 4) | d\n    }\n    return v & 0xFF\n}\n\nfunction clamp(v: number, lo: number, hi: number) {\n    return Math.max(lo, Math.min(hi, v))\n}\n\nfunction send(line: string) { bluetooth.uartWriteString(line) }\nfunction sendAck(seq: number) { send(\":\" + hex2(seq) + \",ACK\\n\") }\nfunction sendBusy(seq: number) { send(\":\" + hex2(seq) + \",BUSY\\n\") }\nfunction sendErr(seq: number, ec: number) { send(\":\" + hex2(seq) + \",ERR,\" + hex2(ec) + \"\\n\") }\n\n// ---------- queue ----------\nconst QDEPTH = 6\nconst q: Cmd[] = []\nlet busy = false\n\nfunction qPush(c: Cmd) {\n    if (q.length >= QDEPTH) return false\n    q.push(c)\n    return true\n}\nfunction qPop(): Cmd | null {\n    if (q.length == 0) return null\n    return q.shift()\n}\n\n// ---------- parser ----------\nfunction parseLine(raw: string): Cmd | null {\n    if (!raw) return null\n    // MakeCode-safe: String.replace doesn't take RegExp; use split/join\n    const line = raw.split(\"\\r\").join(\"\").trim()\n    if (line.length < 5) return null\n    if (line.charAt(0) != \":\") return null\n\n    const core = line.substr(1).trim()\n    const parts = core.split(\",\")\n    if (parts.length < 2) return null\n\n    const seq = parseInt(parts[0], 16)\n    const op = (parts[1] || \"\").toUpperCase()\n    const a = parts.length > 2 ? parseHexByte(parts[2]) : 0\n    const b = parts.length > 3 ? parseHexByte(parts[3]) : 0\n    const c = parts.length > 4 ? parseHexByte(parts[4]) : 0\n    return { s: isNaN(seq) ? 0 : (seq & 0xFF), o: op, a: a, b: b, c: c }\n}\n\n// ---------- executor ----------\nfunction runOne(cmd: Cmd, done: () => void) {\n    switch (cmd.o) {\n        case \"MV\": {\n            const L = clamp(cmd.a, -100, 100)\n            const R = clamp(cmd.b, -100, 100)\n            cuteBot.motors(L, R)\n            break\n        }\n        case \"SP\":\n            cuteBot.stopcar()\n            break\n        case \"TL\":\n            cuteBot.turnleft()\n            break\n        case \"TR\":\n            cuteBot.turnright()\n            break\n        case \"BK\": {\n            const spd = cmd.a > 0 ? clamp(cmd.a, 0, 100) : 50\n            cuteBot.motors(-spd, -spd)\n            break\n        }\n        case \"HL\": {\n            if (cmd.b > 0 || cmd.c > 0) {\n                const color = ((cmd.a & 0xFF) << 16) | ((cmd.b & 0xFF) << 8) | (cmd.c & 0xFF)\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            } else {\n                const on = (cmd.a & 0xFF) != 0\n                const color = on ? 0xFFFFFF : 0x000000\n                cuteBot.colorLight(cuteBot.RGBLights.ALL, color)\n                const rr = hex2((color >> 16) & 0xFF)\n                const gg = hex2((color >> 8) & 0xFF)\n                const bb = hex2(color & 0xFF)\n                send(\"#LED,\" + rr + gg + bb + \"\\n\")\n            }\n            break\n        }\n        case \"BZ\": {\n            const freq = clamp(((cmd.a & 0xFF) << 8) | (cmd.b & 0xFF), 100, 5000)\n            let dur = (cmd.c & 0xFF) * 10\n            if (dur <= 0) dur = 100\n            music.playTone(freq, dur)\n            control.inBackground(() => {\n                basic.pause(dur)\n                send(\"#BUZ,done\\n\")\n            })\n            break\n        }\n        case \"EC\":\n            break\n        default:\n            sendErr(cmd.s, 0x01)\n            done()\n            return\n    }\n\n    control.inBackground(() => {\n        basic.pause(10)\n        sendAck(cmd.s)\n        done()\n    })\n}\n\nfunction pump() {\n    if (busy || q.length == 0) return\n    busy = true\n    const cmd: Cmd | null = qPop()\n    if (!cmd) { busy = false; return }\n    runOne(cmd, () => { busy = false; pump() })\n}\n\n// ---------- BLE receive ----------\nbluetooth.onUartDataReceived(\"\\n\", function () {\n    const raw = bluetooth.uartReadUntil(\"\\n\")\n    const cmd: Cmd | null = parseLine(raw)\n    if (!cmd) {\n        sendErr(0x00, 0x02)\n        return\n    }\n    if (busy && q.length >= QDEPTH) { sendBusy(cmd.s); return }\n    if (!qPush(cmd)) { sendBusy(cmd.s); return }\n    pump()\n})\n\n// ---------- telemetry loop ----------\nloops.everyInterval(500, function () {\n    const d = cuteBot.ultrasonic(cuteBot.SonarUnit.Centimeters)\n    bluetooth.uartWriteString(\"#DIST,\" + d + \"\\n\")\n})","README.md":"","main.py":"","pxt.json":"{\n    \"name\": \"Cutebot_OP_v0.1\",\n    \"description\": \"\",\n    \"dependencies\": {\n        \"core\": \"*\",\n        \"microphone\": \"*\",\n        \"bluetooth\": \"*\",\n        \"cutebot\": \"github:elecfreaks/pxt-cutebot#v6.2.4\"\n    },\n    \"files\": [\n        \"main.blocks\",\n        \"main.ts\",\n        \"README.md\",\n        \"main.py\"\n    ],\n    \"preferredEditor\": \"tsprj\",\n    \"yotta\": {\n        \"config\": {\n            \"microbit-dal\": {\n                \"bluetooth\": {\n                    \"open\": 1,\n                    \"pairing_mode\": 0,\n                    \"whitelist\": 0,\n                    \"security_level\": null\n                }\n            }\n        }\n    }\n}\n"}}],"shares":[],"lastSaveTime":1761155672116}